# 分账阶段规划

## 阶段一（基础可用，目标：1 周内完成）
1. **商家分账账号统一**
   - 明确账号来源（复用 `single_royalty` 或新增表），补全 `ROYALTY_TYPE_MERCHANT` 的 `payee_*` 字段读取。
   - 后台配置侧同步校验必填字段、状态启用，避免运行时报错。
   - 更新链路日志，标记收款主体信息。
2. **并发控制升级**
   - `OrderAutoRoyalty` 队列消费改造为 `SET key value NX EX` 分布式锁，失败任务回队。
   - Finally 保障解锁，并在日志中输出锁信息。
3. **文档/测试支撑**
   - 更新 `分账进度实施.md`，补充测试清单。
   - 人工测试：支付回调、补单、手动触发全链路验证。

## 阶段二（自愈能力，目标：1-2 周）
1. **失败自动重试**
   - 设计 `royalty:retry:queue` 或延迟任务，分类错误：临时性自动入队，永久性直接告警。
   - 限制最大重试次数、间隔时间，指标上报。
2. **金额精度与超时**
   - 金额运算统一使用“分”为单位的整数计算，封装校验函数。
   - `AlipayRoyaltyService` 设置连接/响应超时，超时错误标记为可重试。
3. **监控与告警**
   - 失败率、重试次数、锁等待等指标纳入日志/告警。

## 阶段三（性能与一致性，目标：2-3 周）
1. **兜底扫描优化**
   - 查询改为 LEFT JOIN + 新增索引(`order_id`,`royalty_status`)，按主键分页。
   - 支持低峰期批量处理配置。
2. **分账结果查询任务**
   - 实现 `alipay.trade.order.settle.query` 封装。
   - 新增定时任务轮询“分账中”记录，双向对账。
3. **账号与日志完善**
   - 收款账号拉取后统一校验 `user_id / account / name` 和状态。
   - 日志结构化输出（独立 `royalty` channel、链路ID、耗时）。

## 阶段四（收尾与扩展，目标：3-4 周）
1. **文档与测试**
   - 补齐方案/操作文档、测试用例、上线检查表。
2. **扩展优化**
   - 若业务有需要，评估多收款人、多笔分账、回调等功能。
   - 结合监控结果追加优化项（如可视化报表、报警阈值调整）。

> 以上为初版规划，可按优先级/Milestone 做细化及人员分工，后续由你补充具体 owner、环境、验收标准。
