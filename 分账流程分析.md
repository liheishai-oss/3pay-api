# 分账流程分析文档

## 一、触发分账的入口点

### 1. 主要触发点：支付回调后自动入队
**文件位置**：`app/api/controller/v1/PaymentNotifyController.php`

**触发时机**：订单支付成功后，在支付回调处理流程中

**代码位置**：第358-408行

**流程**：
```php
// 在支付回调处理完成后
// 【6.6】加入分账队列
$queueKey = \app\common\constants\CacheKeys::getRoyaltyQueueKey();
$queueData = json_encode([
    'order_id' => $order->id,
    'operator_ip' => $payIp,
    'operator_agent' => $userAgent ?: 'PaymentNotify',
    'timestamp' => time()
]);
\support\Redis::lpush($queueKey, $queueData);
```

**特点**：
- 异步处理，不阻塞支付回调响应
- 将订单ID加入Redis队列 `royalty:queue`
- 记录日志：节点34-分账入队

---

### 2. 自动分账进程：队列处理（秒级）
**文件位置**：`app/process/OrderAutoRoyalty.php`

**触发时机**：每1秒检查一次Redis队列

**代码位置**：第42-44行（定时任务），第62-156行（处理逻辑）

**流程**：
```php
// 每1秒执行一次
new Crontab('* * * * * *', function () {
    $this->processRoyaltyQueue();
});
```

**处理逻辑**：
1. 从Redis队列 `royalty:queue` 中取出订单（批量处理，每次最多10个）
2. 检查订单是否存在
3. 检查是否需要分账（`$order->needsRoyalty()`）
4. 调用 `RoyaltyService::processRoyalty()` 执行分账
5. 记录处理结果日志

**防并发机制**：
- 使用Redis键 `royalty:processing:{order_id}` 标记正在处理
- 如果正在处理，将任务重新放回队列
- 处理完成后清除标记

---

### 3. 自动分账进程：兜底扫描（定时）
**文件位置**：`app/process/OrderAutoRoyalty.php`

**触发时机**：每10分钟扫描一次数据库

**代码位置**：第47-49行（定时任务），第173-252行（处理逻辑）

**流程**：
```php
// 每10分钟执行一次
new Crontab('*/10 * * * *', function () {
    $this->processAutoRoyalty();
});
```

**处理逻辑**：
1. 查询已支付超过5分钟但未分账的订单
2. 检查是否需要分账
3. 调用 `RoyaltyService::processRoyalty()` 执行分账
4. 记录处理结果统计

**兜底机制的作用**：
- 防止Redis队列丢失（Redis故障、重启等情况）
- 防止入队失败（网络抖动、Redis连接失败等）
- 防止进程重启导致队列任务丢失
- 确保所有已支付订单最终都能被分账处理

---

### 4. 手动触发：管理员操作
**文件位置**：`app/service/royalty/RoyaltyService.php`

**方法**：`RoyaltyService::manualRoyalty()`

**代码位置**：第345-358行

**触发方式**：通过管理后台手动触发分账

---

## 二、分账处理流程

### 核心服务：RoyaltyService::processRoyalty()

**文件位置**：`app/service/royalty/RoyaltyService.php`

**完整流程**：

#### 步骤1：检查分账条件
```php
if (!$order->needsRoyalty()) {
    return ['success' => false, 'message' => '订单不需要分账'];
}
```

**检查项**（`Order::needsRoyalty()`）：
- 订单状态必须是已支付（`PAY_STATUS_PAID`）
- 不存在成功分账记录
- 主体（Subject）必须存在
- 主体的分账方式不为"不分账"（`royalty_type !== 'none'`）

---

#### 步骤2：防止重复分账
```php
if (OrderRoyalty::hasSuccessRoyalty($order->id)) {
    return ['success' => false, 'message' => '订单已存在成功分账记录'];
}
```

---

#### 步骤3：计算分账金额
```php
$royaltyData = self::calculateRoyaltyAmount($order, $subject);
```

**分账类型**：

1. **不分账**（`ROYALTY_TYPE_NONE`）
   - 分账金额 = 0
   - 主体金额 = 订单金额

2. **单笔分账**（`ROYALTY_TYPE_SINGLE`）
   - 从 `single_royalty` 表获取收款人信息
   - 按配置的分账比例计算
   - 分账金额 = 订单金额 × (分账比例 / 100)
   - 主体金额 = 订单金额 - 分账金额

3. **商家分账**（`ROYALTY_TYPE_MERCHANT`）
   - 从商户配置获取收款信息
   - 商户收款90%，平台（主体）收款10%
   - 分账金额 = 订单金额 × 10%
   - 主体金额 = 订单金额 - 分账金额

---

#### 步骤4：创建分账记录
```php
$royaltyRecord = OrderRoyalty::create([
    'order_id' => $order->id,
    'platform_order_no' => $order->platform_order_no,
    'trade_no' => $order->trade_no ?? $order->alipay_order_no,
    'royalty_type' => $subject->royalty_type,
    'royalty_mode' => $subject->royalty_mode,
    'royalty_rate' => $subject->royalty_rate,
    'royalty_amount' => $royaltyData['royalty_amount'],
    'royalty_status' => OrderRoyalty::ROYALTY_STATUS_PENDING, // 待分账
    // ... 其他字段
]);
```

**记录日志**：节点33-分账开始

---

#### 步骤5：验证必要信息
```php
// 验证支付宝交易号
if (empty($tradeNo)) {
    throw new Exception("订单缺少支付宝交易号，无法进行分账");
}

// 验证收款人支付宝用户ID
if (empty($royaltyData['payee_user_id'])) {
    throw new Exception("分账收款人支付宝用户ID为空，无法进行分账");
}
```

---

#### 步骤6：调用支付宝分账接口
```php
// 更新状态为"分账中"
$royaltyRecord->royalty_status = OrderRoyalty::ROYALTY_STATUS_PROCESSING;
$royaltyRecord->save();

// 获取支付配置
$paymentConfig = PaymentFactory::getPaymentConfig($subject, $paymentType);

// 调用支付宝分账接口
$alipayResult = AlipayRoyaltyService::royalty(
    [
        'trade_no' => $tradeNo,
        'platform_order_no' => $order->platform_order_no,
        'order_amount' => $order->order_amount,
    ],
    [
        'royalty_amount' => $royaltyData['royalty_amount'],
        'payee_user_id' => $royaltyData['payee_user_id'],
        'payee_name' => $royaltyData['payee_name'] ?? '',
    ],
    $paymentConfig
);
```

---

#### 步骤7：更新分账记录

**成功情况**：
```php
$royaltyRecord->royalty_status = OrderRoyalty::ROYALTY_STATUS_SUCCESS;
$royaltyRecord->royalty_time = date('Y-m-d H:i:s');
$royaltyRecord->alipay_royalty_no = $alipayResult['data']['royalty_no'] ?? '';
$royaltyRecord->alipay_result = json_encode($alipayResult['data'], JSON_UNESCAPED_UNICODE);
```

**失败情况**：
```php
$royaltyRecord->royalty_status = OrderRoyalty::ROYALTY_STATUS_FAILED;
$royaltyRecord->royalty_error = $alipayResult['message'] ?? '分账失败';
$royaltyRecord->alipay_result = json_encode($alipayResult, JSON_UNESCAPED_UNICODE);

// 检查是否需要关闭分账主体
if (RoyaltyConstants::shouldDisableSubject($subCode, $errorMessage)) {
    $subject->status = Subject::STATUS_DISABLED;
    $subject->save();
    // 发送Telegram通知
}
```

**记录日志**：节点34-分账结果

---

## 三、分账状态流转

```
待分账 (PENDING)
    ↓
分账中 (PROCESSING)
    ↓
分账成功 (SUCCESS) 或 分账失败 (FAILED)
```

**状态常量**（`OrderRoyalty`）：
- `ROYALTY_STATUS_PENDING = 0` - 待分账
- `ROYALTY_STATUS_PROCESSING = 1` - 分账中
- `ROYALTY_STATUS_SUCCESS = 2` - 分账成功
- `ROYALTY_STATUS_FAILED = 3` - 分账失败

---

## 四、关键配置

### 1. 进程配置
**文件位置**：`config/process.php`

```php
'order-auto-royalty' => [
    'handler' => app\process\OrderAutoRoyalty::class,
],
```

### 2. Redis队列键
**文件位置**：`app/common/constants/CacheKeys.php`

- 分账队列：`royalty:queue`
- 处理中标记：`royalty:processing:{order_id}`

### 3. 日志配置
**文件位置**：`config/log.php`

```php
'royalty' => [
    'handlers' => [
        [
            'class' => \Monolog\Handler\RotatingFileHandler::class,
            'constructor' => [
                runtime_path() . '/logs/royalty.log',
                7, // 保留7天
                \Monolog\Logger::DEBUG,
            ],
        ],
    ],
],
```

---

## 五、流程图

```
支付回调 (PaymentNotifyController)
    ↓
订单支付成功
    ↓
加入分账队列 (Redis: royalty:queue)
    ↓
    ↓
自动分账进程 (OrderAutoRoyalty)
    ├─ 队列处理（每1秒）
    │   └─ 从队列取出订单
    │       └─ 调用 RoyaltyService::processRoyalty()
    │
    └─ 兜底扫描（每10分钟）
        └─ 扫描已支付但未分账的订单
            └─ 调用 RoyaltyService::processRoyalty()
    ↓
RoyaltyService::processRoyalty()
    ├─ 检查分账条件
    ├─ 计算分账金额
    ├─ 创建分账记录
    ├─ 调用支付宝分账接口
    └─ 更新分账记录状态
    ↓
分账完成（成功/失败）
```

---

## 六、注意事项

1. **防重复分账**：
   - 使用数据库锁检查是否已存在成功分账记录
   - 使用Redis键标记正在处理，防止并发

2. **错误处理**：
   - 分账失败时，根据错误码判断是否需要关闭分账主体
   - 特定错误码会触发主体自动关闭和Telegram通知

3. **性能优化**：
   - 队列处理采用批量方式，每次最多处理10个订单
   - 兜底扫描延迟5分钟，避免与队列处理冲突

4. **日志记录**：
   - 所有分账操作都有详细的日志记录
   - 使用独立的日志通道 `royalty` 记录分账相关日志
   - 订单链路日志记录关键节点（节点33、节点34）

---

## 七、相关文件清单

1. **控制器**：
   - `app/api/controller/v1/PaymentNotifyController.php` - 支付回调入口

2. **进程**：
   - `app/process/OrderAutoRoyalty.php` - 自动分账进程

3. **服务**：
   - `app/service/royalty/RoyaltyService.php` - 分账核心服务
   - `app/service/alipay/AlipayRoyaltyService.php` - 支付宝分账接口

4. **模型**：
   - `app/model/Order.php` - 订单模型（包含 `needsRoyalty()` 方法）
   - `app/model/OrderRoyalty.php` - 分账记录模型
   - `app/model/Subject.php` - 主体模型（包含分账配置）

5. **常量**：
   - `app/common/constants/CacheKeys.php` - Redis键常量
   - `app/common/constants/RoyaltyConstants.php` - 分账相关常量

6. **配置**：
   - `config/process.php` - 进程配置
   - `config/log.php` - 日志配置


