# æ•°æ®åº“åˆ†è´¦è¡¨æ£€æŸ¥æŠ¥å‘Š

**æ£€æŸ¥æ—¶é—´**: 2024å¹´
**æ•°æ®åº“**: third_party_payment
**Dockerå®¹å™¨**: mysql (ID: 83ea0ce5ada5)

---

## âœ… æ£€æŸ¥ç»“æœ

### 1. è¡¨æ˜¯å¦å­˜åœ¨
**ç»“æœ**: âœ… **è¡¨ `order_royalty` å­˜åœ¨**

---

### 2. è¡¨ç»“æ„

#### å­—æ®µåˆ—è¡¨ï¼ˆå…±21ä¸ªå­—æ®µï¼‰

| å­—æ®µå | ç±»å‹ | æ˜¯å¦ä¸ºç©º | é”® | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|----------|-----|--------|------|
| id | bigint | NO | PRI | NULL | ä¸»é”®IDï¼ˆè‡ªå¢ï¼‰ |
| order_id | int | NO | MUL | NULL | è®¢å•ID |
| platform_order_no | varchar(64) | NO | MUL | NULL | å¹³å°è®¢å•å· |
| trade_no | varchar(64) | YES | MUL | NULL | æ”¯ä»˜å®äº¤æ˜“å· |
| royalty_type | varchar(20) | NO | | NULL | åˆ†è´¦æ–¹å¼ï¼ˆnone/single/merchantï¼‰ |
| royalty_mode | varchar(20) | YES | | NULL | åˆ†è´¦æ¨¡å¼ï¼ˆnormal/master_subï¼‰ |
| royalty_rate | decimal(5,2) | YES | | NULL | åˆ†è´¦æ¯”ä¾‹ï¼ˆç™¾åˆ†æ¯”ï¼‰ |
| subject_id | int | NO | MUL | NULL | ä¸»ä½“ID |
| subject_amount | decimal(10,2) | NO | | NULL | ä¸»ä½“æ”¶æ¬¾é‡‘é¢ |
| payee_type | varchar(20) | YES | | NULL | æ”¶æ¬¾äººç±»å‹ï¼ˆagent/merchant/singleï¼‰ |
| payee_id | int | YES | | NULL | æ”¶æ¬¾äººID |
| payee_name | varchar(100) | YES | | NULL | æ”¶æ¬¾äººåç§° |
| payee_account | varchar(100) | YES | | NULL | æ”¶æ¬¾äººè´¦å· |
| payee_user_id | varchar(64) | YES | | NULL | æ”¶æ¬¾äººæ”¯ä»˜å®ç”¨æˆ·ID |
| royalty_amount | decimal(10,2) | YES | | NULL | åˆ†è´¦é‡‘é¢ |
| royalty_status | tinyint | NO | MUL | 0 | åˆ†è´¦çŠ¶æ€ï¼ˆ0=å¾…åˆ†è´¦, 1=åˆ†è´¦ä¸­, 2=åˆ†è´¦æˆåŠŸ, 3=åˆ†è´¦å¤±è´¥ï¼‰ |
| royalty_time | timestamp | YES | | NULL | åˆ†è´¦æ—¶é—´ |
| royalty_error | text | YES | | NULL | åˆ†è´¦å¤±è´¥åŸå›  |
| alipay_royalty_no | varchar(64) | YES | | NULL | æ”¯ä»˜å®åˆ†è´¦å•å· |
| alipay_result | text | YES | | NULL | æ”¯ä»˜å®åˆ†è´¦è¿”å›ç»“æœï¼ˆJSONï¼‰ |
| created_at | timestamp | NO | MUL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | timestamp | YES | | NULL | æ›´æ–°æ—¶é—´ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰ |

---

### 3. ç´¢å¼•ä¿¡æ¯

è¡¨åŒ…å« **7ä¸ªç´¢å¼•**ï¼š

| ç´¢å¼•å | ç±»å‹ | å­—æ®µ | è¯´æ˜ |
|--------|------|------|------|
| PRIMARY | UNIQUE | id | ä¸»é”®ç´¢å¼• |
| idx_order_id | INDEX | order_id | è®¢å•IDç´¢å¼• |
| idx_platform_order_no | INDEX | platform_order_no | å¹³å°è®¢å•å·ç´¢å¼• |
| idx_trade_no | INDEX | trade_no | æ”¯ä»˜å®äº¤æ˜“å·ç´¢å¼• |
| idx_royalty_status | INDEX | royalty_status | åˆ†è´¦çŠ¶æ€ç´¢å¼• |
| idx_subject_id | INDEX | subject_id | ä¸»ä½“IDç´¢å¼• |
| idx_created_at | INDEX | created_at | åˆ›å»ºæ—¶é—´ç´¢å¼• |

**ç´¢å¼•è¯„ä»·**: âœ… ç´¢å¼•è®¾è®¡åˆç†ï¼Œè¦†ç›–äº†ä¸»è¦æŸ¥è¯¢å­—æ®µ

---

### 4. æ•°æ®ç»Ÿè®¡

- **æ€»è®°å½•æ•°**: 0 æ¡
- **è¯´æ˜**: å½“å‰è¡¨ä¸ºç©ºï¼Œè¿˜æ²¡æœ‰åˆ†è´¦è®°å½•

---

## âœ… è¡¨ç»“æ„å®Œæ•´æ€§æ£€æŸ¥

### å…³é”®å­—æ®µæ£€æŸ¥

æ‰€æœ‰å¿…éœ€å­—æ®µéƒ½å­˜åœ¨ï¼š

- âœ… `id` - ä¸»é”®
- âœ… `order_id` - è®¢å•ID
- âœ… `platform_order_no` - å¹³å°è®¢å•å·
- âœ… `royalty_status` - åˆ†è´¦çŠ¶æ€
- âœ… `royalty_amount` - åˆ†è´¦é‡‘é¢
- âœ… `subject_amount` - ä¸»ä½“é‡‘é¢
- âœ… `royalty_type` - åˆ†è´¦æ–¹å¼
- âœ… `royalty_mode` - åˆ†è´¦æ¨¡å¼
- âœ… `royalty_rate` - åˆ†è´¦æ¯”ä¾‹
- âœ… `payee_user_id` - æ”¶æ¬¾äººæ”¯ä»˜å®ç”¨æˆ·ID
- âœ… `alipay_royalty_no` - æ”¯ä»˜å®åˆ†è´¦å•å·
- âœ… `created_at` - åˆ›å»ºæ—¶é—´
- âœ… `updated_at` - æ›´æ–°æ—¶é—´

---

## ğŸ“‹ åˆ†è´¦çŠ¶æ€è¯´æ˜

| çŠ¶æ€å€¼ | çŠ¶æ€åç§° | è¯´æ˜ |
|--------|----------|------|
| 0 | å¾…åˆ†è´¦ (PENDING) | åˆ†è´¦è®°å½•å·²åˆ›å»ºï¼Œç­‰å¾…å¤„ç† |
| 1 | åˆ†è´¦ä¸­ (PROCESSING) | æ­£åœ¨è°ƒç”¨æ”¯ä»˜å®åˆ†è´¦æ¥å£ |
| 2 | åˆ†è´¦æˆåŠŸ (SUCCESS) | æ”¯ä»˜å®åˆ†è´¦æˆåŠŸ |
| 3 | åˆ†è´¦å¤±è´¥ (FAILED) | æ”¯ä»˜å®åˆ†è´¦å¤±è´¥ |

---

## ğŸ” éªŒè¯å‘½ä»¤

å¦‚æœéœ€è¦åœ¨Dockerå®¹å™¨ä¸­æŸ¥è¯¢è¡¨ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

### 1. æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
```bash
docker exec mysql mysql -u third_party_payment -prA8f@D2kLmZx!3pQ third_party_payment -e "SHOW TABLES LIKE 'order_royalty';"
```

### 2. æŸ¥çœ‹è¡¨ç»“æ„
```bash
docker exec mysql mysql -u third_party_payment -prA8f@D2kLmZx!3pQ third_party_payment -e "DESCRIBE order_royalty;"
```

### 3. æŸ¥çœ‹ç´¢å¼•
```bash
docker exec mysql mysql -u third_party_payment -prA8f@D2kLmZx!3pQ third_party_payment -e "SHOW INDEX FROM order_royalty;"
```

### 4. æŸ¥è¯¢åˆ†è´¦è®°å½•
```bash
docker exec mysql mysql -u third_party_payment -prA8f@D2kLmZx!3pQ third_party_payment -e "SELECT * FROM order_royalty ORDER BY id DESC LIMIT 10;"
```

### 5. æŒ‰çŠ¶æ€ç»Ÿè®¡
```bash
docker exec mysql mysql -u third_party_payment -prA8f@D2kLmZx!3pQ third_party_payment -e "SELECT royalty_status, COUNT(*) as count FROM order_royalty GROUP BY royalty_status;"
```

---

## âœ… æ€»ç»“

1. **è¡¨å­˜åœ¨**: âœ… `order_royalty` è¡¨å·²åˆ›å»º
2. **è¡¨ç»“æ„**: âœ… æ‰€æœ‰å¿…éœ€å­—æ®µå®Œæ•´
3. **ç´¢å¼•**: âœ… ç´¢å¼•è®¾è®¡åˆç†
4. **æ•°æ®**: å½“å‰æ— æ•°æ®ï¼ˆæ–°è¡¨ï¼‰
5. **é…ç½®**: ä¸ä»£ç æ¨¡å‹å®šä¹‰ä¸€è‡´

**ç»“è®º**: æ•°æ®åº“ä¸­çš„åˆ†è´¦è¡¨å·²æ­£ç¡®åˆ›å»ºï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

- **æ¨¡å‹æ–‡ä»¶**: `app/model/OrderRoyalty.php`
- **æœåŠ¡æ–‡ä»¶**: `app/service/royalty/RoyaltyService.php`
- **è¿›ç¨‹æ–‡ä»¶**: `app/process/OrderAutoRoyalty.php`
- **æ•°æ®åº“é…ç½®**: `config/database.php`

---

**æ£€æŸ¥å®Œæˆæ—¶é—´**: 2024å¹´


