# 投诉拉黑用户ID获取优化实施总结

## 一、优化概述

### 优化目标
将投诉拉黑时的用户ID获取方式从直接使用支付宝API返回的 `ComplainantID`，改为根据投诉详情中的订单号查询本地订单表，获取真实的购买者UID（`buyer_id`）进行拉黑。

### 优化原因
1. **数据准确性更高**：使用订单表中的 `buyer_id`，这是支付时的真实支付宝用户ID
2. **支持多订单场景**：可以处理涉及多个订单的投诉，拉黑所有相关的购买者
3. **数据一致性更好**：与订单支付流程保持一致，不依赖API返回的可能不准确的字段
4. **容错性更强**：有回退机制，即使查询不到订单，仍可使用 `ComplainantID`

---

## 二、实施内容

### 1. 创建Order模型

**文件**：`internal/model/order.go`

**功能**：
- 定义订单模型，对应PHP的 `order` 表
- 包含关键字段：`PlatformOrderNo`、`MerchantOrderNo`、`AlipayOrderNo`、`BuyerID`、`PayStatus`、`PayIP`、`FirstOpenIP` 等
- 提供辅助方法：`HasBuyerID()`、`IsPaid()`

### 2. 创建OrderRepository

**文件**：`internal/repository/order_repo.go`

**功能**：
- `FindByMerchantOrderNo()`：根据商户订单号查询订单
- `FindByPlatformOrderNo()`：根据平台订单号（支付宝订单号）查询订单
- `FindByOrderNos()`：批量查询订单（支持商户订单号和平台订单号）
- `GetBuyerIDsByOrderNos()`：根据订单号列表获取购买者UID列表（去重，只返回已支付订单的buyer_id）
- `GetOrderIPAndDevice()`：获取订单的IP地址和设备信息（用于拉黑）

### 3. 修改SubjectWorker

**文件**：`internal/worker/subject_worker.go`

**修改内容**：
- 添加 `orderRepo *repository.OrderRepository` 字段
- 修改 `NewSubjectWorker()` 函数，添加 `orderRepo` 参数
- 在 `processComplaint()` 方法中，添加 `processBlacklistFromOrders()` 调用
- 新增 `processBlacklistFromOrders()` 方法：根据订单列表处理拉黑
- 新增 `fallbackToComplainantID()` 方法：回退使用ComplainantID进行拉黑

### 4. 修改Manager

**文件**：`internal/worker/manager.go`

**修改内容**：
- 添加 `orderRepo *repository.OrderRepository` 字段
- 修改 `NewManager()` 函数，添加 `orderRepo` 参数
- 修改 `createWorker()` 方法，传递 `orderRepo` 给 `NewSubjectWorker()`

### 5. 修改main.go

**文件**：`cmd/main.go`

**修改内容**：
- 初始化 `OrderRepository`：`orderRepo := repository.NewOrderRepository(db, log)`
- 将 `orderRepo` 传递给 `worker.NewManager()`

---

## 三、核心逻辑流程

### 1. 投诉处理流程

```
1. 获取投诉详情（从支付宝API）
   ↓
2. 提取订单列表（TargetOrderList）
   ↓
3. 保存投诉数据到数据库
   ↓
4. 根据订单号查询本地订单表
   ↓
5. 获取购买者UID列表（buyer_id）
   ↓
6. 对每个buyer_id进行拉黑
   ↓
7. 如果查询失败，回退使用ComplainantID
```

### 2. 拉黑处理流程

```
processBlacklistFromOrders()
   ↓
提取订单号列表（merchant_order_no、platform_order_no）
   ↓
批量查询订单（GetBuyerIDsByOrderNos）
   ↓
获取购买者UID列表（去重，只返回已支付订单）
   ↓
对每个buyer_id：
   - 获取IP地址（从订单表）
   - 调用拉黑服务（AddToBlacklist）
   ↓
如果查询失败或buyer_id为空：
   - 回退使用ComplainantID（fallbackToComplainantID）
```

### 3. 回退机制

```
查询订单失败 OR buyer_id为空
   ↓
查询投诉记录（FindByComplaintNo）
   ↓
获取ComplainantID
   ↓
使用ComplainantID进行拉黑
```

---

## 四、关键特性

### 1. 批量查询优化
- 使用 `WHERE IN` 批量查询订单，减少数据库查询次数
- 支持同时查询商户订单号和平台订单号
- 自动去重，只返回唯一的 `buyer_id`

### 2. 数据过滤
- 只拉黑已支付订单的购买者（`IsPaid()` 检查）
- 只拉黑有 `buyer_id` 的订单（`HasBuyerID()` 检查）
- 自动跳过空的 `buyer_id`

### 3. 错误处理
- 查询失败时，回退使用 `ComplainantID`
- 部分订单查询失败时，其他订单仍可正常处理
- 拉黑失败时，记录错误日志但不中断流程

### 4. 日志记录
- 记录详细的拉黑处理日志
- 记录查询失败和回退情况
- 记录拉黑成功和失败的数量

### 5. IP地址获取
- 优先使用支付IP（`pay_ip`）
- 如果没有支付IP，使用首次打开IP（`first_open_ip`）
- 如果都没有，IP地址为空（不影响拉黑）

---

## 五、测试建议

### 1. 单订单投诉测试
- 测试单个订单的投诉，验证能否正确获取 `buyer_id` 并拉黑
- 验证IP地址是否正确获取

### 2. 多订单投诉测试
- 测试多个订单的投诉，验证能否正确获取所有订单的 `buyer_id` 并拉黑
- 验证去重逻辑是否正确

### 3. 订单不存在测试
- 测试订单不存在的情况，验证回退机制是否正常工作
- 验证是否使用 `ComplainantID` 进行拉黑

### 4. buyer_id为空测试
- 测试订单的 `buyer_id` 为空的情况，验证是否能正确处理
- 验证是否回退使用 `ComplainantID`

### 5. 未支付订单测试
- 测试未支付订单的情况，验证是否跳过未支付订单
- 验证只拉黑已支付订单的购买者

### 6. 性能测试
- 测试批量查询订单的性能
- 验证是否满足性能要求

---

## 六、注意事项

### 1. 数据库字段
- 确保 `order` 表存在 `buyer_id` 字段
- 确保 `buyer_id` 字段在支付回调或补单时已正确更新
- 确保 `merchant_order_no` 和 `alipay_order_no` 字段有索引

### 2. 数据一致性
- 确保订单数据已及时同步
- 如果订单数据未及时同步，可能无法获取 `buyer_id`，会回退使用 `ComplainantID`

### 3. 性能考虑
- 批量查询订单时，使用 `WHERE IN` 优化性能
- 如果订单数量很大，考虑分批查询
- 可以考虑添加查询缓存

### 4. 日志监控
- 监控查询失败率和回退使用 `ComplainantID` 的频率
- 如果回退频率过高，需要检查订单数据同步情况
- 监控拉黑成功率和失败率

---

## 七、后续优化建议

### 1. 设备码获取
- 如果订单表中有设备码字段，可以从订单中获取设备码
- 目前设备码为空，可以后续添加

### 2. 查询缓存
- 对于频繁查询的订单，可以使用Redis缓存
- 减少数据库查询次数，提高性能

### 3. 批量拉黑优化
- 如果多个订单属于同一个购买者，可以合并拉黑操作
- 减少拉黑服务调用次数

### 4. 监控和告警
- 添加监控指标（查询成功率、拉黑成功率等）
- 添加告警机制（订单查询失败率过高时告警）
- 添加日志分析（分析查询失败的原因）

### 5. 数据同步优化
- 确保订单数据及时同步
- 如果订单数据未及时同步，可以考虑异步同步机制

---

## 八、文件清单

### 新增文件
1. `internal/model/order.go` - Order模型
2. `internal/repository/order_repo.go` - OrderRepository
3. `投诉拉黑用户ID获取方案分析.md` - 方案分析文档
4. `优化实施总结.md` - 本文档

### 修改文件
1. `internal/worker/subject_worker.go` - 添加订单查询和拉黑逻辑
2. `internal/worker/manager.go` - 添加OrderRepository支持
3. `cmd/main.go` - 初始化OrderRepository

---

## 九、总结

### 优化成果
1. ✅ 创建了Order模型和OrderRepository
2. ✅ 修改了SubjectWorker，添加了订单查询和拉黑逻辑
3. ✅ 实现了回退机制，确保拉黑的可靠性
4. ✅ 支持多订单场景，可以拉黑所有相关的购买者
5. ✅ 添加了详细的日志记录，便于排查问题

### 优化效果
1. **数据准确性提升**：使用订单表中的真实 `buyer_id`，不再依赖可能不准确的 `ComplainantID`
2. **功能完善**：支持多订单场景，可以处理涉及多个订单的投诉
3. **容错性增强**：有回退机制，即使查询不到订单，仍可使用 `ComplainantID`
4. **可维护性提升**：代码结构清晰，易于维护和扩展

### 下一步
1. 测试验证优化后的功能
2. 监控查询失败率和回退频率
3. 根据监控数据优化查询性能
4. 添加设备码获取功能（如果订单表中有设备码字段）






