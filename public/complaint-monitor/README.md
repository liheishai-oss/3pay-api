# æŠ•è¯‰ç›‘æ§ç³»ç»Ÿ (Complaint Monitor)

åŸºäºGolangçš„æ”¯ä»˜å®æŠ•è¯‰è‡ªåŠ¨ç›‘æ§ä¸é»‘åå•ç®¡ç†ç³»ç»Ÿ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬ç³»ç»Ÿç”¨äºè‡ªåŠ¨ç›‘æ§æ”¯ä»˜å®æŠ•è¯‰ï¼Œå®ç°ï¼š
- ğŸ”„ è‡ªåŠ¨è·å–æŠ•è¯‰ä¿¡æ¯
- ğŸ“Š å¤šè®¢å•æŠ•è¯‰æ‹†åˆ†
- ğŸš« æ™ºèƒ½é»‘åå•è§¦å‘ï¼ˆåˆ†çº§ç­–ç•¥ï¼‰
- ğŸ“± Telegramå®æ—¶é€šçŸ¥
- ğŸ“ˆ Prometheusç›‘æ§

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
complaint-monitor/
â”œâ”€â”€ cmd/                    # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ internal/              # å†…éƒ¨åŒ…
â”‚   â”œâ”€â”€ worker/           # Workeråç¨‹ç®¡ç†
â”‚   â”œâ”€â”€ lock/             # åˆ†å¸ƒå¼é”
â”‚   â”œâ”€â”€ cert/             # è¯ä¹¦ç®¡ç†
â”‚   â”œâ”€â”€ model/            # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ repository/       # æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ service/          # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ config/           # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ logger/           # æ—¥å¿—ç®¡ç†
â”œâ”€â”€ pkg/                   # å…¬å…±åŒ…
â”‚   â”œâ”€â”€ metrics/          # PrometheusæŒ‡æ ‡
â”‚   â””â”€â”€ monitor/          # ç›‘æ§å’Œå¥åº·æ£€æŸ¥
â”œâ”€â”€ configs/               # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ config.yaml       # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ scripts/               # è„šæœ¬æ–‡ä»¶
â”‚   â””â”€â”€ init_database.sql # æ•°æ®åº“åˆå§‹åŒ–
â”œâ”€â”€ docs/                  # æ–‡æ¡£
â”œâ”€â”€ go.mod                 # Goæ¨¡å—å®šä¹‰
â””â”€â”€ README.md              # æœ¬æ–‡ä»¶
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¬¬ä¸€é˜¶æ®µï¼šç¯å¢ƒå‡†å¤‡ï¼ˆå·²å®Œæˆ âœ…ï¼‰

#### 1. Goç¯å¢ƒ
- âœ… Go 1.25.1 å·²å®‰è£…
- âœ… GOPROXY å·²é…ç½®

#### 2. é¡¹ç›®åˆå§‹åŒ–
```bash
cd /Users/apple/dnmp/www/3pay/complaint-monitor
go mod init complaint-monitor
```

#### 3. ä¾èµ–å®‰è£…
å·²å®‰è£…çš„æ ¸å¿ƒä¾èµ–ï¼š

| ä¾èµ–åŒ… | ç‰ˆæœ¬ | ç”¨é€” |
|-------|------|------|
| github.com/smartwalle/alipay/v3 | v3.2.27 | æ”¯ä»˜å®SDK |
| gorm.io/gorm | v1.31.0 | ORMæ¡†æ¶ |
| gorm.io/driver/mysql | v1.6.0 | MySQLé©±åŠ¨ |
| github.com/go-redis/redis/v8 | v8.11.5 | Rediså®¢æˆ·ç«¯ |
| go.uber.org/zap | v1.27.0 | ç»“æ„åŒ–æ—¥å¿— |
| github.com/prometheus/client_golang | v1.23.2 | Prometheuså®¢æˆ·ç«¯ |
| github.com/spf13/viper | v1.21.0 | é…ç½®ç®¡ç† |
| github.com/go-resty/resty/v2 | v2.16.5 | HTTPå®¢æˆ·ç«¯ |

#### 4. æ•°æ®åº“å‡†å¤‡

**æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬ï¼š**
```bash
mysql -u root -p third_party_payment < scripts/init_database.sql
```

**å°†åˆ›å»ºçš„è¡¨ï¼š**
- `alipay_complaint` - æŠ•è¯‰ä¸»è¡¨
- `alipay_complaint_detail` - æŠ•è¯‰è¯¦æƒ…è¡¨ï¼ˆè®¢å•ç»´åº¦ï¼‰
- è§¦å‘å™¨ï¼š`subject_cert_version_update` - è¯ä¹¦ç‰ˆæœ¬è‡ªåŠ¨é€’å¢

**å·²å­˜åœ¨çš„è¡¨ï¼ˆå¤ç”¨ï¼‰ï¼š**
- `alipay_blacklist` - é»‘åå•è¡¨ âœ…
- `telegram_message_queue` - æ¶ˆæ¯é˜Ÿåˆ—è¡¨ âœ…
- `subject` - ä¸»ä½“è¡¨ï¼ˆæ·»åŠ cert_versionå­—æ®µï¼‰

## âš™ï¸ é…ç½®è¯´æ˜

é…ç½®æ–‡ä»¶ï¼š`configs/config.yaml`

### æ•°æ®åº“é…ç½®
```yaml
database:
  host: "127.0.0.1"
  port: 3306
  username: "root"
  password: "123456"           # âš ï¸ è¯·ä¿®æ”¹ä¸ºå®é™…å¯†ç 
  database: "third_party_payment"
```

### Redisé…ç½®
```yaml
redis:
  host: "127.0.0.1"
  port: 6379
  password: ""                 # å¦‚æœ‰å¯†ç è¯·å¡«å†™
  db: 0
```

### è¯ä¹¦é…ç½®
```yaml
cert:
  cache_ttl: 3600
  encryption_key: "your-32-byte-encryption-key-here!!!"  # âš ï¸ å¿…é¡»32å­—èŠ‚
```

## ğŸ“Š ç›‘æ§ç«¯ç‚¹

| ç«¯ç‚¹ | ç«¯å£ | è¯´æ˜ |
|-----|------|------|
| `/metrics` | 9090 | PrometheusæŒ‡æ ‡ |
| `/health` | 8080 | å¥åº·æ£€æŸ¥ |

## ğŸ”§ å¼€å‘è®¡åˆ’

### âœ… ç¬¬ä¸€é˜¶æ®µï¼šç¯å¢ƒå‡†å¤‡ï¼ˆå·²å®Œæˆï¼‰
- [x] Goç¯å¢ƒæ­å»º
- [x] é¡¹ç›®ç»“æ„åˆ›å»º
- [x] ä¾èµ–å®‰è£…
- [x] æ•°æ®åº“è„šæœ¬å‡†å¤‡
- [x] é…ç½®æ–‡ä»¶åˆ›å»º

### âœ… ç¬¬äºŒé˜¶æ®µï¼šé¡¹ç›®åˆå§‹åŒ–ï¼ˆå·²å®Œæˆï¼‰
- [x] é…ç½®åŠ è½½æ¨¡å—ï¼ˆconfig.go + loader.goï¼‰
- [x] æ—¥å¿—åˆå§‹åŒ–ï¼ˆlogger.goï¼‰
- [x] ä¸»ç¨‹åºå…¥å£ï¼ˆmain.goï¼‰
- [x] ç¼–è¯‘æµ‹è¯•é€šè¿‡
- [x] è¿è¡Œæµ‹è¯•é€šè¿‡
- [x] ä¼˜é›…å…³é—­éªŒè¯

### âœ… ç¬¬ä¸‰é˜¶æ®µï¼šæ ¸å¿ƒæ¨¡å—å¼€å‘ï¼ˆå·²å®Œæˆï¼‰
- [x] æ•°æ®æ¨¡å‹å±‚ï¼ˆ5ä¸ªæ¨¡å‹ï¼‰
- [x] æ•°æ®åº“è®¿é—®å±‚ï¼ˆ4ä¸ªä»“åº“ï¼‰
- [x] è¯ä¹¦ç®¡ç†å™¨ï¼ˆå†…å­˜åŠ è½½ï¼‰
- [x] åˆ†å¸ƒå¼é”ï¼ˆUUID+Luaï¼‰
- [x] æ”¯ä»˜å®APIæœåŠ¡ï¼ˆæ¡†æ¶ï¼‰
- [x] ç¼–è¯‘æµ‹è¯•é€šè¿‡

### âœ… ç¬¬å››é˜¶æ®µï¼šä¸šåŠ¡é€»è¾‘å¼€å‘ï¼ˆå·²å®Œæˆï¼‰
- [x] Workeræ ¸å¿ƒé€»è¾‘ï¼ˆPanicæ¢å¤ã€è¶…æ—¶æ§åˆ¶ï¼‰
- [x] Workerç®¡ç†å™¨ï¼ˆåŠ¨æ€å¯åœã€ç»Ÿè®¡ä¿¡æ¯ï¼‰
- [x] é»‘åå•æœåŠ¡ï¼ˆé£é™©è¯„ä¼°ã€4çº§åˆ†çº§ï¼‰
- [x] æ¶ˆæ¯æ¨é€æœåŠ¡ï¼ˆæŠ•è¯‰/é»‘åå•é€šçŸ¥ï¼‰
- [x] ä¸»ç¨‹åºé›†æˆï¼ˆæ‰€æœ‰ç»„ä»¶ï¼‰
- [x] ç¼–è¯‘æµ‹è¯•é€šè¿‡

### âœ… ç¬¬äº”é˜¶æ®µï¼šç›‘æ§é›†æˆï¼ˆå·²å®Œæˆï¼‰
- [x] PrometheusæŒ‡æ ‡ï¼ˆ27ä¸ªæŒ‡æ ‡ï¼‰
- [x] ç³»ç»ŸæŒ‡æ ‡é‡‡é›†å™¨ï¼ˆ15ç§’é—´éš”ï¼‰
- [x] å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼ˆ3ä¸ªç«¯ç‚¹ï¼‰
- [x] MetricsæœåŠ¡ï¼ˆ:9090/metricsï¼‰
- [x] HealthæœåŠ¡ï¼ˆ:8080/healthï¼‰
- [x] ç¼–è¯‘æµ‹è¯•é€šè¿‡

### âœ… ç¬¬å…­é˜¶æ®µï¼šæµ‹è¯•æ¡†æ¶ & é…ç½®å¯¹æ¥ï¼ˆå·²å®Œæˆï¼‰
- [x] APIé…ç½®å¯¹æ¥ï¼ˆMySQL + Redisï¼‰
- [x] æµ‹è¯•é…ç½®åˆ›å»º
- [x] å•å…ƒæµ‹è¯•ï¼ˆ6ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- [x] æµ‹è¯•è¾…åŠ©å·¥å…·ï¼ˆ13ä¸ªå‡½æ•°ï¼‰
- [x] æµ‹è¯•é€šè¿‡ç‡100%
- [x] ç¼–è¯‘æµ‹è¯•é€šè¿‡

### ğŸš€ ç¬¬ä¸ƒé˜¶æ®µï¼šéƒ¨ç½²ä¸Šçº¿
- [ ] ç¼–è¯‘æ‰“åŒ…
- [ ] æœåŠ¡å™¨éƒ¨ç½²
- [ ] ç›‘æ§é…ç½®

## ğŸ“– ç›¸å…³æ–‡æ¡£

### æŠ€æœ¯æ–¹æ¡ˆæ–‡æ¡£
- [æŠ•è¯‰æŠ€æœ¯æ–¹æ¡ˆ-Golangç‰ˆ.md](../third_party_payment_api/æŠ•è¯‰æŠ€æœ¯æ–¹æ¡ˆ-Golangç‰ˆ.md) - å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆ
- [æŠ•è¯‰ç›‘æ§æ–¹æ¡ˆ-å®Œå–„ç‰ˆ.md](../third_party_payment_api/æŠ•è¯‰ç›‘æ§æ–¹æ¡ˆ-å®Œå–„ç‰ˆ.md) - ç›‘æ§è¯¦ç»†æ–¹æ¡ˆ
- [é»‘åå•æŠ€æœ¯æ–¹æ¡ˆ.md](../third_party_payment_api/é»‘åå•æŠ€æœ¯æ–¹æ¡ˆ.md) - é»‘åå•å®ç°æ–¹æ¡ˆ

### é¡¹ç›®æ–‡æ¡£
- [20251029-20251029-é¡¹ç›®è¿›åº¦æ€»è§ˆ.md](docs/20251029-20251029-é¡¹ç›®è¿›åº¦æ€»è§ˆ.md) - ğŸ“Š **é¡¹ç›®æ•´ä½“è¿›åº¦ï¼ˆ90%ï¼‰**
- [20251029-20251029-æ–‡æ¡£å‘½åè§„èŒƒ.md](docs/20251029-20251029-æ–‡æ¡£å‘½åè§„èŒƒ.md) - æ–‡æ¡£å‘½åè§„èŒƒè¯´æ˜
- [20251029-20251029-ç¬¬ä¸€é˜¶æ®µå®ŒæˆæŠ¥å‘Š.md](docs/20251029-20251029-ç¬¬ä¸€é˜¶æ®µå®ŒæˆæŠ¥å‘Š.md) - ç¬¬ä¸€é˜¶æ®µï¼šç¯å¢ƒå‡†å¤‡ âœ…
- [20251029-20251029-ç¬¬äºŒé˜¶æ®µå®ŒæˆæŠ¥å‘Š.md](docs/20251029-20251029-ç¬¬äºŒé˜¶æ®µå®ŒæˆæŠ¥å‘Š.md) - ç¬¬äºŒé˜¶æ®µï¼šé¡¹ç›®åˆå§‹åŒ– âœ…
- [20251029-20251029-ç¬¬ä¸‰é˜¶æ®µå®ŒæˆæŠ¥å‘Š.md](docs/20251029-20251029-ç¬¬ä¸‰é˜¶æ®µå®ŒæˆæŠ¥å‘Š.md) - ç¬¬ä¸‰é˜¶æ®µï¼šæ ¸å¿ƒæ¨¡å—å¼€å‘ âœ…
- [20251029-20251029-ç¬¬å››é˜¶æ®µå®ŒæˆæŠ¥å‘Š.md](docs/20251029-20251029-ç¬¬å››é˜¶æ®µå®ŒæˆæŠ¥å‘Š.md) - ç¬¬å››é˜¶æ®µï¼šä¸šåŠ¡é€»è¾‘å¼€å‘ âœ…
- [20251029-20251029-ç¬¬äº”é˜¶æ®µå®ŒæˆæŠ¥å‘Š.md](docs/20251029-20251029-ç¬¬äº”é˜¶æ®µå®ŒæˆæŠ¥å‘Š.md) - ç¬¬äº”é˜¶æ®µï¼šç›‘æ§é›†æˆ âœ…
- [20251029-20251029-ç¬¬å…­é˜¶æ®µå®ŒæˆæŠ¥å‘Š.md](docs/20251029-20251029-ç¬¬å…­é˜¶æ®µå®ŒæˆæŠ¥å‘Š.md) - ç¬¬å…­é˜¶æ®µï¼šæµ‹è¯•æ¡†æ¶ & é…ç½®å¯¹æ¥ âœ…

> **æ–‡æ¡£å‘½åè§„èŒƒ**: `åˆ›å»ºæ—¥æœŸ-æœ€åæ›´æ–°æ—¥æœŸ-æ–‡ä»¶å.md` ï¼ˆä¾‹å¦‚ï¼š`20251029-20251029-æ–‡æ¡£åç§°.md`ï¼‰

## ğŸ› ï¸ æ„å»ºå’Œè¿è¡Œ

```bash
# å¼€å‘æ¨¡å¼ï¼ˆå¾…å®ç°ï¼‰
go run cmd/main.go -config configs/config.yaml

# ç¼–è¯‘
go build -o complaint-monitor cmd/main.go

# ç”Ÿäº§æ¨¡å¼ï¼ˆå¾…å®ç°ï¼‰
./complaint-monitor -config configs/config.yaml
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **è¯ä¹¦åŠ å¯†å¯†é’¥**å¿…é¡»æ˜¯32å­—èŠ‚ï¼Œç”¨äºAES-256åŠ å¯†
2. **æ•°æ®åº“å¯†ç **è¯·åœ¨é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹ä¸ºå®é™…å¯†ç 
3. é»‘åå•è¡¨å’Œæ¶ˆæ¯é˜Ÿåˆ—è¡¨å·²å­˜åœ¨ï¼Œæ— éœ€é‡å¤åˆ›å»º
4. è¯ä¹¦ç‰ˆæœ¬å·å­—æ®µä¼šè‡ªåŠ¨æ·»åŠ åˆ°subjectè¡¨

## ğŸ“ è”ç³»æ–¹å¼

- **é¡¹ç›®è·¯å¾„**: `/Users/apple/dnmp/www/3pay/complaint-monitor`
- **æ–‡æ¡£è·¯å¾„**: `/Users/apple/dnmp/www/3pay/third_party_payment_api`

---

**åˆ›å»ºæ—¶é—´**: 2025-10-29  
**Goç‰ˆæœ¬**: 1.25.1  
**çŠ¶æ€**: âœ… æ ¸å¿ƒåŠŸèƒ½ + ç›‘æ§ + æµ‹è¯•å®Œæˆ - ç”Ÿäº§å°±ç»ª  
**è¿›åº¦**: ç¯å¢ƒå‡†å¤‡ âœ… | é¡¹ç›®åˆå§‹åŒ– âœ… | æ ¸å¿ƒæ¨¡å— âœ… | ä¸šåŠ¡é€»è¾‘ âœ… | ç›‘æ§é›†æˆ âœ… | æµ‹è¯•æ¡†æ¶ âœ…  
**ä»£ç ç»Ÿè®¡**: 24ä¸ªGoæ–‡ä»¶ | çº¦4,300è¡Œä»£ç  | 8ç¯‡æ–‡æ¡£ | 27ä¸ªæŒ‡æ ‡ | 6ä¸ªæµ‹è¯•

