# ç¬¬ä¸‰é˜¶æ®µå®ŒæˆæŠ¥å‘Š âœ…

> **æ–‡æ¡£å‘½åè§„èŒƒ**: `åˆ›å»ºæ—¥æœŸ-æœ€åæ›´æ–°æ—¥æœŸ-æ–‡ä»¶å.md`  
> **æ–‡æ¡£åç§°**: `20251029-20251029-ç¬¬ä¸‰é˜¶æ®µå®ŒæˆæŠ¥å‘Š.md`

**åˆ›å»ºæ—¶é—´**: 2025-10-29  
**æ›´æ–°æ—¶é—´**: 2025-10-29  
**é˜¶æ®µåç§°**: æ ¸å¿ƒæ¨¡å—å¼€å‘ï¼ˆæ•°æ®æ¨¡å‹ã€æ•°æ®åº“ã€è¯ä¹¦ã€é”ã€APIï¼‰  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ å®Œæˆæ¸…å•

### 1. æ•°æ®æ¨¡å‹å±‚ âœ…

#### internal/model/ï¼ˆ5ä¸ªæ–‡ä»¶ï¼‰

| æ–‡ä»¶ | æ¨¡å‹ | è¯´æ˜ |
|-----|------|------|
| `subject.go` | Subject | ä¸»ä½“æ¨¡å‹ï¼ˆç®€åŒ–ï¼Œç§»é™¤è¯ä¹¦å­—æ®µï¼‰ |
| `subject_cert.go` | SubjectCert | ä¸»ä½“è¯ä¹¦æ¨¡å‹ï¼ˆæ–°å¢ï¼‰ |
| `complaint.go` | Complaint | æŠ•è¯‰ä¸»è¡¨æ¨¡å‹ |
| `complaint_detail.go` | ComplaintDetail | æŠ•è¯‰è¯¦æƒ…æ¨¡å‹ï¼ˆè®¢å•ç»´åº¦ï¼‰ |
| `blacklist.go` | AlipayBlacklist | æ”¯ä»˜å®é»‘åå•æ¨¡å‹ |

**Subject æ¨¡å‹ç»“æ„**:
```go
âœ… ID - ä¸»é”®
âœ… MerchantID - å•†æˆ·ID  
âœ… SubjectName - ä¸»ä½“åç§°
âœ… AppID - æ”¯ä»˜å®AppID
âœ… Status - çŠ¶æ€ï¼ˆ1-æ¿€æ´» 0-ç¦ç”¨ï¼‰
âœ… VerifyDevice - è®¾å¤‡éªŒè¯å¼€å…³
âœ… AllowRemoteOrder - å…è®¸å¼‚åœ°æ‹‰å•
âœ… Cert - å…³è”è¯ä¹¦ï¼ˆ*SubjectCertï¼‰
âœ… IsActive() - æ˜¯å¦æ¿€æ´»
âœ… HasCert() - æ˜¯å¦æœ‰è¯ä¹¦
```

**SubjectCert æ¨¡å‹ç»“æ„** (æ–°å¢):
```go
âœ… ID - ä¸»é”®
âœ… SubjectID - ä¸»ä½“ID
âœ… AppPrivateKey - åº”ç”¨ç§é’¥ï¼ˆæ•æ„Ÿï¼‰
âœ… AppCertContent - åº”ç”¨è¯ä¹¦å†…å®¹
âœ… AlipayRootCertContent - æ ¹è¯ä¹¦å†…å®¹
âœ… AlipayCertContent - æ”¯ä»˜å®è¯ä¹¦å†…å®¹
âœ… CertStorageType - è¯ä¹¦å­˜å‚¨ç±»å‹
âœ… CertVersion - è¯ä¹¦ç‰ˆæœ¬å·
âœ… HasCertContent() - æ˜¯å¦æœ‰è¯ä¹¦å†…å®¹
âœ… UseDatabaseCert() - æ˜¯å¦ä½¿ç”¨æ•°æ®åº“å­˜å‚¨
```

**Complaint æ¨¡å‹ç»“æ„**:
```go
âœ… ID - ä¸»é”®
âœ… SubjectID - ä¸»ä½“ID
âœ… ComplaintNo - æŠ•è¯‰å•å·ï¼ˆå”¯ä¸€ï¼‰
âœ… ComplaintType - æŠ•è¯‰ç±»å‹
âœ… ComplaintStatus - æŠ•è¯‰çŠ¶æ€
âœ… ComplainantID - æŠ•è¯‰äººæ”¯ä»˜å®ç”¨æˆ·ID
âœ… ComplaintTime - æŠ•è¯‰æ—¶é—´
âœ… ComplaintReason - æŠ•è¯‰åŸå› 
âœ… Details - å…³è”æŠ•è¯‰è¯¦æƒ…åˆ—è¡¨
âœ… GetComplaintKey() - è·å–é”é”®
âœ… IsProcessing() / IsClosed() - çŠ¶æ€åˆ¤æ–­
```

**ComplaintDetail æ¨¡å‹ç»“æ„**:
```go
âœ… ID - ä¸»é”®
âœ… ComplaintID - æŠ•è¯‰ä¸»è¡¨ID
âœ… SubjectID - ä¸»ä½“ID
âœ… ComplaintNo - æŠ•è¯‰å•å·
âœ… MerchantOrderNo - å•†æˆ·è®¢å•å·
âœ… PlatformOrderNo - å¹³å°è®¢å•å·
âœ… OrderAmount - è®¢å•é‡‘é¢
âœ… ComplaintAmount - æŠ•è¯‰é‡‘é¢
âœ… IsPushed - æ˜¯å¦å·²æ¨é€
âœ… PushedAt - æ¨é€æ—¶é—´
âœ… IsPushedStatus() - æ˜¯å¦å·²æ¨é€
âœ… MarkAsPushed() - æ ‡è®°ä¸ºå·²æ¨é€
```

**AlipayBlacklist æ¨¡å‹ç»“æ„**:
```go
âœ… ID - ä¸»é”®
âœ… SubjectID - ä¸»ä½“ID
âœ… AlipayUserID - æ”¯ä»˜å®ç”¨æˆ·ID
âœ… DeviceCode - è®¾å¤‡æŒ‡çº¹
âœ… IPAddress - IPåœ°å€
âœ… BlacklistType - æ‹‰é»‘ç±»å‹
âœ… RiskLevel - é£é™©ç­‰çº§
âœ… ComplaintCount - æŠ•è¯‰æ¬¡æ•°
âœ… LastComplaintTime - æœ€åæŠ•è¯‰æ—¶é—´
âœ… IsLowRisk() / IsMediumRisk() / IsHighRisk() / IsCriticalRisk()
âœ… IncrementComplaintCount() - å¢åŠ æŠ•è¯‰æ¬¡æ•°
âœ… UpdateRiskLevel() - æ›´æ–°é£é™©ç­‰çº§
```

---

### 2. æ•°æ®åº“è®¿é—®å±‚ âœ…

#### internal/repository/ï¼ˆ4ä¸ªæ–‡ä»¶ï¼‰

| æ–‡ä»¶ | ä»“åº“ | æ–¹æ³•æ•° |
|-----|------|-------|
| `database.go` | Database | 8ä¸ª |
| `subject_repo.go` | SubjectRepository | 11ä¸ª |
| `complaint_repo.go` | ComplaintRepository | 13ä¸ª |
| `blacklist_repo.go` | BlacklistRepository | 12ä¸ª |

**Database ç®¡ç†å™¨**:
```go
âœ… NewDatabase() - åˆ›å»ºæ•°æ®åº“è¿æ¥
âœ… GetDB() - è·å–GORMå®ä¾‹
âœ… Close() - å…³é—­è¿æ¥
âœ… HealthCheck() - å¥åº·æ£€æŸ¥
âœ… GetStats() - è·å–è¿æ¥æ± ç»Ÿè®¡
âœ… WithTransaction() - æ‰§è¡Œäº‹åŠ¡
âœ… BaseRepository - åŸºç¡€ä»“åº“å®ç°
```

**SubjectRepository**:
```go
âœ… FindByID() - æ ¹æ®IDæŸ¥æ‰¾
âœ… FindByAppID() - æ ¹æ®AppIDæŸ¥æ‰¾
âœ… FindAllActive() - æŸ¥æ‰¾æ‰€æœ‰æ¿€æ´»ä¸»ä½“
âœ… FindAll() - æŸ¥æ‰¾æ‰€æœ‰ä¸»ä½“
âœ… FindActiveWithCert() - æŸ¥æ‰¾æ¿€æ´»ä¸”æœ‰è¯ä¹¦çš„ä¸»ä½“
âœ… FindCertBySubjectID() - æ ¹æ®ä¸»ä½“IDæŸ¥æ‰¾è¯ä¹¦
âœ… LoadSubjectWithCert() - åŠ è½½ä¸»ä½“å’Œè¯ä¹¦
âœ… Count() - ç»Ÿè®¡ä¸»ä½“æ•°é‡
âœ… CountActive() - ç»Ÿè®¡æ¿€æ´»ä¸»ä½“æ•°é‡
âœ… Update() - æ›´æ–°ä¸»ä½“
```

**ComplaintRepository**:
```go
âœ… Create() - åˆ›å»ºæŠ•è¯‰è®°å½•
âœ… CreateDetail() - åˆ›å»ºæŠ•è¯‰è¯¦æƒ…
âœ… FindByComplaintNo() - æ ¹æ®æŠ•è¯‰å•å·æŸ¥æ‰¾
âœ… FindDetailsByComplaintID() - æŸ¥æ‰¾æŠ•è¯‰è¯¦æƒ…åˆ—è¡¨
âœ… FindUnpushedDetails() - æŸ¥æ‰¾æœªæ¨é€çš„è¯¦æƒ…
âœ… MarkDetailAsPushed() - æ ‡è®°è¯¦æƒ…ä¸ºå·²æ¨é€
âœ… UpdateComplaint() - æ›´æ–°æŠ•è¯‰
âœ… ExistsDetail() - æ£€æŸ¥è¯¦æƒ…æ˜¯å¦å­˜åœ¨
âœ… CreateWithDetails() - åˆ›å»ºæŠ•è¯‰å’Œè¯¦æƒ…ï¼ˆäº‹åŠ¡ï¼‰
âœ… CountBySubject() - ç»Ÿè®¡ä¸»ä½“æŠ•è¯‰æ•°é‡
âœ… CountByComplainant() - ç»Ÿè®¡æŠ•è¯‰äººæŠ•è¯‰æ¬¡æ•°
```

**BlacklistRepository**:
```go
âœ… Create() - åˆ›å»ºé»‘åå•è®°å½•
âœ… FindByAlipayUserID() - æ ¹æ®ç”¨æˆ·IDæŸ¥æ‰¾
âœ… Exists() - æ£€æŸ¥æ˜¯å¦åœ¨é»‘åå•ä¸­
âœ… Upsert() - æ’å…¥æˆ–æ›´æ–°ï¼ˆON DUPLICATE KEY UPDATEï¼‰
âœ… Update() - æ›´æ–°é»‘åå•
âœ… IncrementComplaintCount() - å¢åŠ æŠ•è¯‰æ¬¡æ•°
âœ… UpdateRiskLevel() - æ›´æ–°é£é™©ç­‰çº§
âœ… FindByRiskLevel() - æ ¹æ®é£é™©ç­‰çº§æŸ¥æ‰¾
âœ… CountBySubject() - ç»Ÿè®¡ä¸»ä½“é»‘åå•æ•°é‡
âœ… CountByRiskLevel() - ç»Ÿè®¡å„é£é™©ç­‰çº§æ•°é‡
âœ… Delete() - åˆ é™¤é»‘åå•
```

---

### 3. è¯ä¹¦ç®¡ç†å™¨ âœ…

#### internal/cert/manager.go

**æ ¸å¿ƒç‰¹æ€§**:
```go
âœ… å†…å­˜åŠ è½½æ¨¡å¼ï¼ˆæ°¸ä¸è½ç›˜ï¼‰
âœ… è¯ä¹¦ç¼“å­˜æœºåˆ¶ï¼ˆTTLæ§åˆ¶ï¼‰
âœ… ç‰ˆæœ¬å·æ£€æµ‹ï¼ˆè‡ªåŠ¨å¤±æ•ˆï¼‰
âœ… AES-256è§£å¯†æ”¯æŒ
âœ… æ”¯ä»˜å®å®¢æˆ·ç«¯å¤ç”¨
âœ… çº¿ç¨‹å®‰å…¨ï¼ˆsync.RWMutexï¼‰
âœ… æ•æ„Ÿæ•°æ®æ¸…ç†ï¼ˆå¸®åŠ©GCï¼‰
```

**ä¸»è¦æ–¹æ³•**:
```go
âœ… NewCertManager() - åˆ›å»ºç®¡ç†å™¨
âœ… LoadCert() - åŠ è½½è¯ä¹¦ï¼ˆå†…å­˜æ¨¡å¼ï¼‰
âœ… decrypt() - AESè§£å¯†
âœ… getFromCache() - ä»ç¼“å­˜è·å–
âœ… CleanExpired() - æ¸…ç†è¿‡æœŸç¼“å­˜
âœ… InvalidateCache() - ä½¿ç¼“å­˜å¤±æ•ˆ
âœ… GetCacheStats() - è·å–ç¼“å­˜ç»Ÿè®¡
```

**å®‰å…¨ç‰¹æ€§**:
- âœ… è¯ä¹¦å†…å®¹æ°¸ä¸å†™å…¥ä¸´æ—¶æ–‡ä»¶
- âœ… ä½¿ç”¨`LoadXxxFromData()`ä»å†…å­˜åŠ è½½
- âœ… å¯†é’¥å­˜å‚¨æ”¯æŒAES-256åŠ å¯†
- âœ… åŠ è½½åç«‹å³æ¸…é™¤æ•æ„Ÿå˜é‡å¼•ç”¨
- âœ… è¯ä¹¦ç‰ˆæœ¬å˜æ›´è‡ªåŠ¨å¤±æ•ˆç¼“å­˜

---

### 4. åˆ†å¸ƒå¼é” âœ…

#### internal/lock/distributed_lock.go

**æ ¸å¿ƒç‰¹æ€§**:
```go
âœ… UUIDé”å€¼ï¼ˆé˜²è¯¯é‡Šæ”¾ï¼‰
âœ… Luaè„šæœ¬åŸå­æ“ä½œ
âœ… åŠ¨æ€TTLï¼ˆæ ¹æ®è®¢å•æ•°ï¼‰
âœ… é”ç»­æœŸæ”¯æŒ
âœ… è‡ªåŠ¨ç»­æœŸï¼ˆåå°åç¨‹ï¼‰
```

**ä¸»è¦æ–¹æ³•**:
```go
âœ… NewDistributedLock() - åˆ›å»ºé”ç®¡ç†å™¨
âœ… AcquireLock() - è·å–é”ï¼ˆUUID+TTLï¼‰
âœ… ReleaseLock() - é‡Šæ”¾é”ï¼ˆLuaè„šæœ¬ï¼‰
âœ… RenewLock() - ç»­æœŸé”
âœ… AutoRenewLock() - è‡ªåŠ¨ç»­æœŸ
âœ… calculateLockTTL() - åŠ¨æ€è®¡ç®—TTL
âœ… generateUUID() - ç”ŸæˆUUID
```

**å®‰å…¨ä¿éšœ**:
```lua
-- é‡Šæ”¾é”çš„Luaè„šæœ¬ï¼ˆåŸå­æ“ä½œï¼‰
if redis.call("get", KEYS[1]) == ARGV[1] then
    return redis.call("del", KEYS[1])
else
    return 0
end
```

**TTLè®¡ç®—é€»è¾‘**:
- åŸºç¡€TTLï¼š60ç§’
- æ¯ä¸ªè®¢å•é¢å¤–å¢åŠ ï¼š500ms
- æœ€å¤§TTLï¼š300ç§’

---

### 5. æ”¯ä»˜å®APIæœåŠ¡ âœ…

#### internal/service/alipay_service.go

**æ¡†æ¶ç»“æ„**:
```go
âœ… NewAlipayService() - åˆ›å»ºæœåŠ¡
âœ… FetchComplaintList() - è·å–æŠ•è¯‰åˆ—è¡¨ï¼ˆæ¡†æ¶ï¼‰
âœ… FetchComplaintDetail() - è·å–æŠ•è¯‰è¯¦æƒ…ï¼ˆæ¡†æ¶ï¼‰
âœ… FinishComplaint() - å®Œç»“æŠ•è¯‰ï¼ˆæ¡†æ¶ï¼‰
âœ… ReplyComplaint() - å›å¤æŠ•è¯‰ï¼ˆæ¡†æ¶ï¼‰
```

**è¯·æ±‚å‚æ•°ç»“æ„**:
```go
âœ… ComplaintListRequest - æŠ•è¯‰åˆ—è¡¨è¯·æ±‚
âœ… ComplaintDetailRequest - æŠ•è¯‰è¯¦æƒ…è¯·æ±‚
```

**ç‰¹æ€§**:
- âœ… æ—¥å¿—è®°å½•ï¼ˆè°ƒç”¨å‰åï¼‰
- âœ… è€—æ—¶ç»Ÿè®¡
- âœ… é”™è¯¯å¤„ç†æ¡†æ¶
- âš ï¸  å…·ä½“APIè°ƒç”¨éœ€è¦åç»­å®ç°

---

## ğŸ“Š ç»Ÿè®¡æ•°æ®

| æŒ‡æ ‡ | æ•°é‡ |
|-----|------|
| **æ–°å¢Goæ–‡ä»¶** | 11ä¸ª |
| **æ•°æ®æ¨¡å‹** | 5ä¸ª |
| **ä»“åº“ç±»** | 4ä¸ª |
| **æ–°å¢ä»£ç è¡Œ** | çº¦1800è¡Œ |
| **æ¨¡å‹æ–¹æ³•** | 30+ |
| **ä»“åº“æ–¹æ³•** | 44+ |
| **æ€»è€—æ—¶** | çº¦45åˆ†é’Ÿ |

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½éªŒè¯

### âœ… æ•°æ®æ¨¡å‹
- [x] è¡¨åæ˜ å°„ï¼ˆTableNameï¼‰
- [x] å­—æ®µæ ‡ç­¾ï¼ˆgorm, jsonï¼‰
- [x] å…³è”å…³ç³»ï¼ˆSubject->Certï¼‰
- [x] è¾…åŠ©æ–¹æ³•å®Œå–„
- [x] æ•æ„Ÿå­—æ®µä¿æŠ¤ï¼ˆjson:"-"ï¼‰

### âœ… æ•°æ®åº“è®¿é—®
- [x] GORMé›†æˆ
- [x] è¿æ¥æ± é…ç½®
- [x] å¥åº·æ£€æŸ¥
- [x] CRUDæ“ä½œ
- [x] äº‹åŠ¡æ”¯æŒ
- [x] ç»Ÿè®¡æŸ¥è¯¢

### âœ… è¯ä¹¦ç®¡ç†
- [x] å†…å­˜åŠ è½½ï¼ˆä¸è½ç›˜ï¼‰
- [x] ç¼“å­˜æœºåˆ¶
- [x] ç‰ˆæœ¬æ§åˆ¶
- [x] åŠ å¯†è§£å¯†
- [x] çº¿ç¨‹å®‰å…¨

### âœ… åˆ†å¸ƒå¼é”
- [x] Redisé›†æˆ
- [x] UUIDé”å€¼
- [x] Luaè„šæœ¬
- [x] åŠ¨æ€TTL
- [x] é”ç»­æœŸ

### âœ… APIæœåŠ¡
- [x] æ¡†æ¶æ­å»º
- [x] æ—¥å¿—è®°å½•
- [x] é”™è¯¯å¤„ç†

---

## ğŸ“ é¡¹ç›®ç»“æ„æ›´æ–°

```
complaint-monitor/
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ main.go
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ cert/
â”‚   â”‚   â””â”€â”€ manager.go                    âœ… æ–°å¢ï¼ˆè¯ä¹¦ç®¡ç†å™¨ï¼‰
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ config.go
â”‚   â”‚   â””â”€â”€ loader.go
â”‚   â”œâ”€â”€ lock/
â”‚   â”‚   â””â”€â”€ distributed_lock.go           âœ… æ–°å¢ï¼ˆåˆ†å¸ƒå¼é”ï¼‰
â”‚   â”œâ”€â”€ logger/
â”‚   â”‚   â””â”€â”€ logger.go
â”‚   â”œâ”€â”€ model/                             âœ… æ–°å¢ç›®å½•
â”‚   â”‚   â”œâ”€â”€ subject.go                    âœ… æ–°å¢ï¼ˆä¸»ä½“æ¨¡å‹ï¼‰
â”‚   â”‚   â”œâ”€â”€ subject_cert.go               âœ… æ–°å¢ï¼ˆè¯ä¹¦æ¨¡å‹ï¼‰
â”‚   â”‚   â”œâ”€â”€ complaint.go                  âœ… æ–°å¢ï¼ˆæŠ•è¯‰æ¨¡å‹ï¼‰
â”‚   â”‚   â”œâ”€â”€ complaint_detail.go           âœ… æ–°å¢ï¼ˆæŠ•è¯‰è¯¦æƒ…ï¼‰
â”‚   â”‚   â””â”€â”€ blacklist.go                  âœ… æ–°å¢ï¼ˆé»‘åå•æ¨¡å‹ï¼‰
â”‚   â”œâ”€â”€ repository/                        âœ… æ–°å¢ç›®å½•
â”‚   â”‚   â”œâ”€â”€ database.go                   âœ… æ–°å¢ï¼ˆæ•°æ®åº“ç®¡ç†ï¼‰
â”‚   â”‚   â”œâ”€â”€ subject_repo.go               âœ… æ–°å¢ï¼ˆä¸»ä½“ä»“åº“ï¼‰
â”‚   â”‚   â”œâ”€â”€ complaint_repo.go             âœ… æ–°å¢ï¼ˆæŠ•è¯‰ä»“åº“ï¼‰
â”‚   â”‚   â””â”€â”€ blacklist_repo.go             âœ… æ–°å¢ï¼ˆé»‘åå•ä»“åº“ï¼‰
â”‚   â””â”€â”€ service/                           âœ… æ–°å¢ç›®å½•
â”‚       â””â”€â”€ alipay_service.go             âœ… æ–°å¢ï¼ˆAPIæœåŠ¡ï¼‰
â”œâ”€â”€ configs/
â”‚   â””â”€â”€ config.yaml
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ 20251029-20251029-æ–‡æ¡£å‘½åè§„èŒƒ.md
â”‚   â”œâ”€â”€ 20251029-20251029-ç¬¬ä¸€é˜¶æ®µå®ŒæˆæŠ¥å‘Š.md
â”‚   â”œâ”€â”€ 20251029-20251029-ç¬¬äºŒé˜¶æ®µå®ŒæˆæŠ¥å‘Š.md
â”‚   â””â”€â”€ 20251029-20251029-ç¬¬ä¸‰é˜¶æ®µå®ŒæˆæŠ¥å‘Š.md  âœ… æœ¬æ–‡ä»¶
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â””â”€â”€ complaint-monitor                     âœ… å¯æ‰§è¡Œæ–‡ä»¶
```

---

## ğŸ§ª ç¼–è¯‘éªŒè¯

```bash
cd /Users/apple/dnmp/www/3pay/complaint-monitor
go build -o complaint-monitor cmd/main.go

âœ… ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯
```

---

## ğŸ” é‡è¦è®¾è®¡è¯´æ˜

### 1. è¯ä¹¦åˆ†è¡¨è®¾è®¡ âœ…

æ ¹æ®å®é™…æ•°æ®åº“ç»“æ„ï¼Œè¯ä¹¦ä¿¡æ¯å­˜å‚¨åœ¨ç‹¬ç«‹çš„ `subject_cert` è¡¨ä¸­ï¼š

**ä¼˜åŠ¿**:
- âœ… è¯ä¹¦æ•°æ®ä¸ä¸»ä½“æ•°æ®åˆ†ç¦»
- âœ… ä¾¿äºè¯ä¹¦å•ç‹¬ç®¡ç†å’Œæ›´æ–°
- âœ… å‡å°‘ä¸»ä½“è¡¨å­—æ®µæ•°é‡
- âœ… æ”¯æŒä¸€å¯¹ä¸€å…³è”åŠ è½½

**å…³è”æ–¹å¼**:
```go
// Subject æ¨¡å‹
type Subject struct {
    // ... å…¶ä»–å­—æ®µ
    Cert *SubjectCert `gorm:"-" json:"cert,omitempty"`
}

// åŠ è½½ä¸»ä½“å’Œè¯ä¹¦
subject, err := repo.LoadSubjectWithCert(subjectID)
```

### 2. è¯ä¹¦å†…å­˜åŠ è½½ âœ…

å®Œå…¨é¿å…ä¸´æ—¶æ–‡ä»¶ï¼š

```go
// ä½¿ç”¨ LoadXxxFromData() æ–¹æ³•
client.LoadAppCertPublicKeyFromData([]byte(appCert))
client.LoadAliPayRootCertFromData([]byte(alipayRootCert))
client.LoadAliPayPublicCertFromData([]byte(alipayCert))

// åŠ è½½åç«‹å³æ¸…é™¤å¼•ç”¨
privateKey = ""
appCert = ""
alipayRootCert = ""
alipayCert = ""
```

### 3. åˆ†å¸ƒå¼é”å®‰å…¨æ€§ âœ…

ä½¿ç”¨UUIDå’ŒLuaè„šæœ¬ä¿è¯å®‰å…¨ï¼š

```go
// è·å–é”æ—¶ç”ŸæˆUUID
lockValue := generateUUID()

// é‡Šæ”¾é”æ—¶éªŒè¯UUIDï¼ˆLuaè„šæœ¬ï¼‰
if redis.call("get", KEYS[1]) == ARGV[1] then
    return redis.call("del", KEYS[1])
else
    return 0
end
```

### 4. é»‘åå•Upsert âœ…

ä½¿ç”¨GORMçš„ON CONFLICTå­å¥ï¼š

```go
err := r.db.Clauses(clause.OnConflict{
    Columns: []clause.Column{{Name: "subject_id"}, {Name: "alipay_user_id"}},
    DoUpdates: clause.AssignmentColumns([]string{
        "device_code", "ip_address", "risk_level", ...
    }),
}).Create(blacklist).Error
```

---

## âš ï¸ å¾…å®ç°åŠŸèƒ½

### æ”¯ä»˜å®APIè°ƒç”¨
```go
// TODO: å®é™…è°ƒç”¨æ”¯ä»˜å®SDK
// å½“å‰ä»…æä¾›æ¡†æ¶ï¼Œå…·ä½“å®ç°éœ€è¦ï¼š
// 1. æŸ¥é˜…æ”¯ä»˜å®SDKæ–‡æ¡£
// 2. å®ç°ComplaintAPIæ¥å£
// 3. å¤„ç†å“åº”æ•°æ®è§£æ
// 4. é”™è¯¯ç å¤„ç†
```

### Redisè¿æ¥åˆå§‹åŒ–
```go
// TODO: åœ¨main.goä¸­åˆå§‹åŒ–Rediså®¢æˆ·ç«¯
// redis := redis.NewClient(&redis.Options{...})
```

### æ•°æ®åº“è¿æ¥åˆå§‹åŒ–
```go
// TODO: åœ¨main.goä¸­åˆå§‹åŒ–æ•°æ®åº“
// db, err := repository.NewDatabase(cfg.Database, log)
```

---

## ğŸš€ ä¸‹ä¸€æ­¥å·¥ä½œï¼ˆç¬¬å››é˜¶æ®µï¼‰

### ä¸šåŠ¡é€»è¾‘å¼€å‘ï¼ˆé¢„è®¡6-8å°æ—¶ï¼‰

#### 1. Workeræ ¸å¿ƒé€»è¾‘ï¼ˆinternal/worker/ï¼‰
- [ ] subject_worker.go - ä¸»ä½“Worker
  - Panicæ¢å¤æœºåˆ¶
  - æŠ•è¯‰è·å–å¾ªç¯
  - æŠ•è¯‰å¤„ç†é€»è¾‘
  - é»‘åå•åˆ¤æ–­

- [ ] manager.go - Workerç®¡ç†å™¨
  - åŠ¨æ€å¯åœ
  - ä¸»ä½“åˆ—è¡¨åˆ·æ–°
  - Workeræ± ç®¡ç†

#### 2. é»‘åå•æœåŠ¡ï¼ˆinternal/service/ï¼‰
- [ ] blacklist_service.go
  - é£é™©è¯„ä¼°ç®—æ³•
  - è‡ªåŠ¨æ‹‰é»‘é€»è¾‘
  - æ¶ˆæ¯æ¨é€

#### 3. æ¶ˆæ¯æ¨é€æœåŠ¡ï¼ˆinternal/service/ï¼‰
- [ ] notification_service.go
  - å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—
  - æ¨¡æ¿æ•°æ®æ„å»º
  - Telegramæ¨é€

#### 4. ä¸»ç¨‹åºé›†æˆï¼ˆcmd/main.goï¼‰
- [ ] åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
- [ ] åˆå§‹åŒ–Redisè¿æ¥
- [ ] å¯åŠ¨Workerç®¡ç†å™¨
- [ ] å¯åŠ¨æŒ‡æ ‡æœåŠ¡
- [ ] å¯åŠ¨å¥åº·æ£€æŸ¥

---

## âœ… éªŒæ”¶æ ‡å‡†è¾¾æˆæƒ…å†µ

| éªŒæ”¶é¡¹ | æ ‡å‡† | å®é™… | çŠ¶æ€ |
|-------|------|------|------|
| æ•°æ®æ¨¡å‹ | 5ä¸ªæ¨¡å‹ | 5ä¸ª | âœ… |
| æ•°æ®åº“ä»“åº“ | 4ä¸ªä»“åº“ | 4ä¸ª | âœ… |
| è¯ä¹¦ç®¡ç†å™¨ | å†…å­˜åŠ è½½ | å·²å®ç° | âœ… |
| åˆ†å¸ƒå¼é” | UUID+Lua | å·²å®ç° | âœ… |
| APIæœåŠ¡ | æ¡†æ¶å®Œæ•´ | å·²å®ç° | âœ… |
| ç¼–è¯‘æµ‹è¯• | æ— é”™è¯¯ | é€šè¿‡ | âœ… |
| ä»£ç è´¨é‡ | ç¬¦åˆè§„èŒƒ | ç¬¦åˆ | âœ… |
| æ–‡æ¡£å®Œæ•´ | é½å…¨ | é½å…¨ | âœ… |

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [20251029-20251029-ç¬¬ä¸€é˜¶æ®µå®ŒæˆæŠ¥å‘Š.md](20251029-20251029-ç¬¬ä¸€é˜¶æ®µå®ŒæˆæŠ¥å‘Š.md) - ç¯å¢ƒå‡†å¤‡
- [20251029-20251029-ç¬¬äºŒé˜¶æ®µå®ŒæˆæŠ¥å‘Š.md](20251029-20251029-ç¬¬äºŒé˜¶æ®µå®ŒæˆæŠ¥å‘Š.md) - é¡¹ç›®åˆå§‹åŒ–
- [20251029-20251029-æ–‡æ¡£å‘½åè§„èŒƒ.md](20251029-20251029-æ–‡æ¡£å‘½åè§„èŒƒ.md) - æ–‡æ¡£è§„èŒƒ
- [../README.md](../README.md) - é¡¹ç›®è¯´æ˜

---

**ç¬¬ä¸‰é˜¶æ®µåœ†æ»¡å®Œæˆï¼ğŸ‰**

**ä¸‹ä¸€æ­¥**: å¼€å§‹ç¬¬å››é˜¶æ®µ - ä¸šåŠ¡é€»è¾‘å¼€å‘ï¼ˆWorkerã€é»‘åå•æœåŠ¡ã€æ¶ˆæ¯æ¨é€ï¼‰

**é¢„è®¡æ—¶é—´**: 6-8å°æ—¶

**å½“å‰è¿›åº¦**: 
- âœ… ç¯å¢ƒå‡†å¤‡
- âœ… é¡¹ç›®åˆå§‹åŒ–  
- âœ… æ ¸å¿ƒæ¨¡å—å¼€å‘
- ğŸ“ ä¸šåŠ¡é€»è¾‘å¼€å‘

