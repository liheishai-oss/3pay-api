# 第一阶段实施步骤说明

## 📋 当前状态

**开始时间**: 2025-11-08  
**当前任务**: 任务1 - 投诉列表查询API  
**进度**: 20%

---

## 任务1: 实现投诉列表查询API

### 步骤1: 查阅支付宝API文档

**目标**: 确认投诉列表查询接口的具体参数和返回格式

**需要确认的信息**:
1. 接口名称：`alipay.merchant.tradecomplain.batchquery`
2. 请求参数：
   - `begin_time`: 查询开始时间（格式：yyyy-MM-dd HH:mm:ss）
   - `end_time`: 查询结束时间（格式：yyyy-MM-dd HH:mm:ss）
   - `page_num`: 页码（从1开始）
   - `page_size`: 每页数量（默认20，最大100）
3. 响应结构：
   - `code`: 响应码（10000表示成功）
   - `msg`: 响应消息
   - `total`: 总数量
   - `complaint_list`: 投诉列表数组
     - `complaint_event_id`: 投诉单号
     - `status`: 投诉状态
     - `complainant_id`: 投诉人ID
     - `gmt_create`: 创建时间
     - `gmt_modified`: 修改时间

**操作**:
- 访问支付宝开放平台文档
- 查找"商户交易投诉"相关API文档
- 确认接口参数和返回格式

---

### 步骤2: 确认SDK调用方法

**目标**: 确认 `smartwalle/alipay/v3` SDK 中如何调用投诉API

**需要确认的信息**:
1. SDK是否直接提供投诉API方法
2. 如果没有，如何使用通用的 `DoRequest()` 方法
3. 请求参数的构建方式
4. 响应数据的解析方式

**操作**:
- 查阅SDK文档和源码
- 查看SDK中是否有 `MerchantTradecomplain` 相关方法
- 如果没有，查看如何使用 `Client.DoRequest()` 调用自定义API

**备选方案**:
- 如果SDK没有直接提供方法，使用 `client.DoRequest()` 方法
- 构建请求参数map
- 调用API并解析响应

---

### 步骤3: 定义响应数据结构

**目标**: 定义投诉列表查询API的响应数据结构

**需要定义的结构**:
1. `ComplaintListResponse`: 投诉列表响应
   - `Total`: 总数量（int64）
   - `ComplaintList`: 投诉列表（[]ComplaintItem）
2. `ComplaintItem`: 投诉项
   - `ComplaintEventID`: 投诉单号（string）
   - `Status`: 投诉状态（string）
   - `ComplainantID`: 投诉人ID（string）
   - `GmtCreate`: 创建时间（string）
   - `GmtModified`: 修改时间（string）

**操作**:
- 在 `alipay_service.go` 中定义响应结构体
- 使用 `json` 标签进行字段映射
- 确保字段类型正确

---

### 步骤4: 实现API调用逻辑

**目标**: 实现投诉列表查询API的调用逻辑

**实现步骤**:
1. 构建请求参数map
   - 设置 `method` 为 `alipay.merchant.tradecomplain.batchquery`
   - 设置 `begin_time`、`end_time`、`page_num`、`page_size`
2. 调用SDK方法
   - 如果SDK有直接方法，使用直接方法
   - 如果没有，使用 `client.DoRequest()` 方法
3. 检查响应码
   - 如果 `code != "10000"`，返回错误
4. 解析响应数据
   - 解析 `total` 字段
   - 解析 `complaint_list` 数组
   - 转换为定义的响应结构
5. 错误处理
   - 网络错误：记录日志并返回错误
   - API错误：记录日志并返回错误（包含错误码和错误消息）
   - 数据解析错误：记录日志并返回错误

**操作**:
- 在 `FetchComplaintList()` 方法中实现上述逻辑
- 添加详细的日志记录
- 添加错误处理

---

### 步骤5: 添加日志和指标

**目标**: 添加详细的日志记录和指标统计

**需要添加的内容**:
1. 日志记录：
   - API调用开始日志（包含请求参数）
   - API调用完成日志（包含响应数据和耗时）
   - 错误日志（包含错误详情）
2. 指标统计：
   - API调用次数（成功/失败）
   - API调用耗时
   - 返回的投诉数量

**操作**:
- 使用 `zap` 记录日志
- 使用 `pkg/metrics` 记录指标
- 确保日志包含足够的信息用于问题排查

---

### 步骤6: 编写单元测试

**目标**: 为投诉列表查询API编写单元测试

**测试用例**:
1. 正常情况：成功获取投诉列表
2. 空列表：没有投诉数据
3. 分页：多页数据
4. 错误情况：API返回错误
5. 网络错误：API调用失败
6. 数据解析错误：响应格式不正确

**操作**:
- 创建测试文件 `alipay_service_test.go`
- 编写测试用例
- 使用mock数据或测试环境
- 确保所有测试用例通过

---

## 任务2: 实现投诉详情查询API

### 步骤1: 查阅支付宝API文档

**目标**: 确认投诉详情查询接口的具体参数和返回格式

**需要确认的信息**:
1. 接口名称：`alipay.merchant.tradecomplain.query`
2. 请求参数：
   - `complaint_event_id`: 投诉单号（必填）
3. 响应结构：
   - `complaint_event_id`: 投诉单号
   - `status`: 投诉状态
   - `complainant_id`: 投诉人ID
   - `complainant_name`: 投诉人姓名
   - `complaint_reason`: 投诉原因
   - `gmt_create`: 创建时间
   - `gmt_modified`: 修改时间
   - `target_order_list`: 订单列表
     - `trade_no`: 支付宝订单号
     - `out_trade_no`: 商户订单号
     - `amount`: 订单金额
     - `complaint_amount`: 投诉金额

**操作**:
- 访问支付宝开放平台文档
- 查找投诉详情查询API文档
- 确认接口参数和返回格式

---

### 步骤2: 定义响应数据结构

**目标**: 定义投诉详情查询API的响应数据结构

**需要定义的结构**:
1. `ComplaintDetailResponse`: 投诉详情响应
   - `ComplaintEventID`: 投诉单号
   - `Status`: 投诉状态
   - `ComplainantID`: 投诉人ID
   - `ComplainantName`: 投诉人姓名
   - `ComplaintReason`: 投诉原因
   - `GmtCreate`: 创建时间
   - `GmtModified`: 修改时间
   - `TargetOrderList`: 订单列表（[]OrderItem）
2. `OrderItem`: 订单项
   - `TradeNo`: 支付宝订单号
   - `OutTradeNo`: 商户订单号
   - `Amount`: 订单金额
   - `ComplaintAmount`: 投诉金额

**操作**:
- 在 `alipay_service.go` 中定义响应结构体
- 使用 `json` 标签进行字段映射
- 确保字段类型正确

---

### 步骤3: 实现API调用逻辑

**目标**: 实现投诉详情查询API的调用逻辑

**实现步骤**:
1. 构建请求参数map
   - 设置 `method` 为 `alipay.merchant.tradecomplain.query`
   - 设置 `complaint_event_id`
2. 调用SDK方法
   - 使用与任务1相同的方式调用API
3. 检查响应码
   - 如果 `code != "10000"`，返回错误
4. 解析响应数据
   - 解析投诉基本信息
   - 解析订单列表（`target_order_list`）
   - 转换为定义的响应结构
5. 错误处理
   - 处理各种错误情况

**操作**:
- 在 `FetchComplaintDetail()` 方法中实现上述逻辑
- 添加详细的日志记录
- 添加错误处理

---

### 步骤4: 编写单元测试

**目标**: 为投诉详情查询API编写单元测试

**测试用例**:
1. 正常情况：成功获取投诉详情
2. 单个订单：投诉包含一个订单
3. 多个订单：投诉包含多个订单
4. 无订单：投诉不包含订单（边界情况）
5. 错误情况：API返回错误
6. 投诉不存在：投诉单号不存在

**操作**:
- 在 `alipay_service_test.go` 中添加测试用例
- 确保所有测试用例通过

---

## 任务3: 实现投诉处理逻辑

### 步骤1: 实现去重检查

**目标**: 在处理投诉前检查是否已存在

**实现步骤**:
1. 调用 `complaintRepo.FindByComplaintNo()` 查询投诉
2. 如果已存在，记录日志并返回（不处理）
3. 如果不存在，继续处理

**操作**:
- 在 `processComplaint()` 方法开始处添加去重检查
- 记录日志说明跳过原因

---

### 步骤2: 获取投诉详情

**目标**: 调用API获取投诉详情

**实现步骤**:
1. 构建请求参数
2. 调用 `alipayService.FetchComplaintDetail()` 获取详情
3. 如果API调用失败，记录错误并返回
4. 如果投诉不存在，记录日志并返回

**操作**:
- 在 `processComplaint()` 方法中调用API
- 添加错误处理

---

### 步骤3: 构建投诉主记录

**目标**: 从API响应构建投诉主记录

**实现步骤**:
1. 创建 `Complaint` 结构体实例
2. 设置基本字段：
   - `SubjectID`: 从 `w.subject.ID` 获取
   - `ComplaintNo`: 从API响应的 `ComplaintEventID` 获取
   - `ComplaintStatus`: 从API响应的 `Status` 获取
   - `ComplainantID`: 从API响应的 `ComplainantID` 获取
   - `ComplaintTime`: 解析API响应的 `GmtCreate` 为 `time.Time`
   - `ComplaintReason`: 从API响应的 `ComplaintReason` 获取
   - `GmtCreate`: 从API响应的 `GmtCreate` 获取（字符串）
   - `GmtModified`: 从API响应的 `GmtModified` 获取（字符串）
3. 实现时间解析函数：将支付宝时间格式（如 "2021-10-20 10:00:00"）转换为 `time.Time`
4. 实现金额解析函数：将字符串金额转换为 `float64`

**操作**:
- 在 `processComplaint()` 方法中构建投诉主记录
- 实现辅助函数用于数据转换

---

### 步骤4: 构建投诉详情记录

**目标**: 从API响应的订单列表构建投诉详情记录

**实现步骤**:
1. 创建 `ComplaintDetail` 数组
2. 遍历API响应的 `TargetOrderList`
3. 对每个订单：
   - 创建 `ComplaintDetail` 实例
   - 设置 `SubjectID`
   - 设置 `ComplaintNo`
   - 设置 `MerchantOrderNo`: 从订单的 `OutTradeNo` 获取
   - 设置 `PlatformOrderNo`: 从订单的 `TradeNo` 获取
   - 设置 `OrderAmount`: 解析订单的 `Amount` 为 `float64`
   - 设置 `ComplaintAmount`: 解析订单的 `ComplaintAmount` 为 `float64`
   - 设置 `AgentID`: 使用 `model.ExtractAgentIDFromOrderNo()` 从 `MerchantOrderNo` 提取
4. 将详情记录添加到数组

**操作**:
- 在 `processComplaint()` 方法中构建投诉详情记录
- 确保正确提取代理商ID

---

### 步骤5: 提取并设置代理商ID

**目标**: 从订单号中提取代理商ID并设置到投诉主记录

**实现步骤**:
1. 如果投诉主记录中没有代理商ID（`AgentID == 0`）
2. 从第一个订单详情中提取代理商ID
3. 设置到投诉主记录的 `AgentID` 字段

**操作**:
- 在构建投诉详情后，提取代理商ID
- 设置到投诉主记录

---

### 步骤6: 保存到数据库

**目标**: 使用事务保存投诉主记录和详情记录

**实现步骤**:
1. 调用 `complaintRepo.CreateWithDetails()` 方法
2. 该方法内部使用事务：
   - 先创建投诉主记录
   - 再创建所有详情记录
   - 如果任何一步失败，整个事务回滚
3. 如果保存失败，记录错误并返回

**操作**:
- 在 `processComplaint()` 方法中调用保存方法
- 添加错误处理

---

### 步骤7: 触发黑名单检查

**目标**: 调用黑名单服务添加投诉人到黑名单

**实现步骤**:
1. 调用 `blacklistSvc.AddToBlacklist()` 方法
2. 传递参数：
   - `subjectID`: 主体ID
   - `alipayUserID`: 投诉人ID
   - `deviceCode`: 设备码（如果有，从订单中获取）
   - `ipAddress`: IP地址（如果有，从订单中获取）
   - `complaintNo`: 投诉单号
3. 如果添加失败，记录错误日志但不阻断流程（因为黑名单不是核心功能）

**操作**:
- 在 `processComplaint()` 方法中调用黑名单服务
- 添加错误处理（不阻断流程）

---

### 步骤8: 推送通知

**目标**: 推送投诉通知到Telegram

**实现步骤**:
1. 评估风险等级：调用 `blacklistSvc.AssessRisk()` 获取风险等级
2. 查询历史投诉次数：调用 `complaintRepo.CountByComplainant()` 获取投诉人历史投诉次数
3. 调用 `notificationService.PushComplaintNotification()` 推送通知
4. 传递参数：
   - `complaint`: 投诉主记录
   - `details`: 投诉详情记录数组
   - `subject`: 主体信息
   - `riskLevel`: 风险等级
   - `historyCount`: 历史投诉次数
5. 如果推送失败，记录错误日志但不阻断流程（因为通知不是核心功能）

**操作**:
- 在 `processComplaint()` 方法中调用通知服务
- 添加错误处理（不阻断流程）

---

## 任务4: 完善 processOnce 方法

### 步骤1: 实现时间范围管理

**目标**: 实现最后查询时间的存储和读取

**实现步骤**:
1. 定义Redis key格式：`complaint:last_query_time:{subject_id}`
2. 读取最后查询时间：
   - 从Redis读取key的值
   - 如果不存在，返回nil（表示首次查询）
3. 计算查询时间范围：
   - 首次查询：使用 `当前时间 - 24小时` 到 `当前时间`
   - 后续查询：使用 `上次查询时间` 到 `当前时间`
4. 更新最后查询时间：
   - 查询完成后，将当前时间写入Redis
   - 设置TTL为7天

**操作**:
- 在 `processOnce()` 方法中实现时间范围管理
- 需要访问Redis客户端（可能需要添加到Worker结构体）

---

### 步骤2: 实现投诉列表查询

**目标**: 调用投诉列表查询API并处理分页

**实现步骤**:
1. 构建请求参数：
   - `BeginTime`: 计算出的开始时间
   - `EndTime`: 当前时间
   - `PageNum`: 从1开始
   - `PageSize`: 20（默认）
2. 循环调用API：
   - 调用 `alipayService.FetchComplaintList()` 获取投诉列表
   - 如果API调用失败，记录错误并返回（等待下次重试）
   - 如果返回的投诉列表为空，跳出循环
   - 处理当前页的投诉列表
   - 如果返回的投诉数量等于 `PageSize`，可能还有更多数据，继续查询下一页
   - 如果返回的投诉数量小于 `PageSize`，说明是最后一页，跳出循环
3. 更新页码，继续查询

**操作**:
- 在 `processOnce()` 方法中实现分页查询逻辑
- 添加错误处理

---

### 步骤3: 处理每个投诉

**目标**: 遍历投诉列表，处理每个投诉

**实现步骤**:
1. 遍历投诉列表
2. 对每个投诉：
   - 调用 `processComplaint()` 方法处理投诉
   - 如果处理失败，记录错误日志但继续处理其他投诉（不阻断流程）
   - 统计处理成功和失败的数量
3. 记录处理统计：
   - 记录本次查询到的投诉数量
   - 记录成功处理的投诉数量
   - 记录处理失败的投诉数量

**操作**:
- 在 `processOnce()` 方法中实现投诉处理循环
- 添加统计和日志记录

---

### 步骤4: 更新最后查询时间

**目标**: 所有投诉处理完成后，更新最后查询时间

**实现步骤**:
1. 所有投诉处理完成后（无论成功或失败）
2. 将当前时间写入Redis
3. key为 `complaint:last_query_time:{subject_id}`
4. 设置TTL为7天
5. 如果Redis操作失败，记录警告日志但不影响主流程

**操作**:
- 在 `processOnce()` 方法末尾更新最后查询时间
- 添加错误处理（不阻断流程）

---

## 实施注意事项

### 1. 代码规范
- 遵循Go语言代码规范
- 使用 `gofmt` 格式化代码
- 添加必要的注释说明

### 2. 错误处理
- 所有错误都要记录日志
- 区分致命错误（需要返回）和非致命错误（记录日志但继续）
- 不要忽略任何错误

### 3. 日志记录
- 记录关键步骤的日志
- 日志包含足够的信息用于问题排查
- 使用结构化日志（zap）

### 4. 测试
- 每个功能实现后都要进行测试
- 测试正常情况和异常情况
- 确保测试通过后再进行下一步

### 5. 进度更新
- 每完成一个步骤，更新文档中的进度
- 记录遇到的问题和解决方案
- 记录实施过程中的重要决策

---

**文档创建时间**: 2025-11-08  
**最后更新时间**: 2025-11-08  
**状态**: 🟡 实施中














