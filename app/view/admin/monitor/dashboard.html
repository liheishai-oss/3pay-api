<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实时监控大屏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .dashboard-container {
            padding: 20px;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .metric-change {
            font-size: 0.8rem;
            margin-top: 5px;
        }
        
        .metric-change.positive {
            color: #4ade80;
        }
        
        .metric-change.negative {
            color: #f87171;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .alert-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid;
        }
        
        .alert-item.P0 {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        .alert-item.P1 {
            border-left-color: #f97316;
            background: rgba(249, 115, 22, 0.1);
        }
        
        .alert-item.P2 {
            border-left-color: #eab308;
            background: rgba(234, 179, 8, 0.1);
        }
        
        .alert-item.P3 {
            border-left-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }
        
        .health-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .health-indicator.healthy {
            background: #22c55e;
        }
        
        .health-indicator.warning {
            background: #eab308;
        }
        
        .health-indicator.critical {
            background: #ef4444;
        }
        
        .health-indicator.error {
            background: #6b7280;
        }
        
        .time-selector {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 20px;
        }
        
        .time-selector .btn {
            margin-right: 10px;
            margin-bottom: 5px;
        }
        
        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .error-item {
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            border-left: 3px solid #ef4444;
        }
        
        .error-message {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .error-time {
            font-size: 0.8rem;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- 时间选择器 -->
        <div class="time-selector">
            <span class="me-3">时间范围：</span>
            <button class="btn btn-outline-light btn-sm" onclick="changeTimeRange('1h')">1小时</button>
            <button class="btn btn-outline-light btn-sm" onclick="changeTimeRange('6h')">6小时</button>
            <button class="btn btn-outline-light btn-sm" onclick="changeTimeRange('24h')">24小时</button>
            <button class="btn btn-outline-light btn-sm" onclick="changeTimeRange('7d')">7天</button>
            <span class="ms-3">
                <i class="bi bi-arrow-clockwise"></i>
                <span id="lastUpdate">最后更新：--</span>
            </span>
        </div>
        
        <!-- 刷新指示器 -->
        <div class="refresh-indicator" id="refreshIndicator" style="display: none;">
            <i class="bi bi-arrow-clockwise spin"></i> 正在刷新...
        </div>
        
        <div class="row">
            <!-- 订单统计 -->
            <div class="col-lg-3 col-md-6">
                <div class="metric-card">
                    <div class="metric-value" id="totalOrders">--</div>
                    <div class="metric-label">总订单数</div>
                    <div class="metric-change" id="totalOrdersChange">--</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="metric-card">
                    <div class="metric-value" id="paidOrders">--</div>
                    <div class="metric-label">已支付订单</div>
                    <div class="metric-change" id="paidOrdersChange">--</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="metric-card">
                    <div class="metric-value" id="conversionRate">--%</div>
                    <div class="metric-label">支付转化率</div>
                    <div class="metric-change" id="conversionRateChange">--</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="metric-card">
                    <div class="metric-value" id="totalAmount">--</div>
                    <div class="metric-label">总交易金额</div>
                    <div class="metric-change" id="totalAmountChange">--</div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- 订单趋势图 -->
            <div class="col-lg-8">
                <div class="metric-card">
                    <h5><i class="bi bi-graph-up"></i> 订单趋势</h5>
                    <div class="chart-container">
                        <canvas id="orderTrendChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- 系统健康状态 -->
            <div class="col-lg-4">
                <div class="metric-card">
                    <h5><i class="bi bi-heart-pulse"></i> 系统健康状态</h5>
                    <div id="systemHealth">
                        <div class="d-flex align-items-center mb-2">
                            <span class="health-indicator" id="overallStatus"></span>
                            <span id="overallStatusText">检查中...</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <span class="health-indicator" id="databaseStatus"></span>
                            <span>数据库</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <span class="health-indicator" id="redisStatus"></span>
                            <span>Redis</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <span class="health-indicator" id="diskStatus"></span>
                            <span>磁盘空间</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <span class="health-indicator" id="memoryStatus"></span>
                            <span>内存使用</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- 预警信息 -->
            <div class="col-lg-6">
                <div class="metric-card">
                    <h5><i class="bi bi-exclamation-triangle"></i> 活跃预警</h5>
                    <div id="alertsList">
                        <div class="text-center text-muted">加载中...</div>
                    </div>
                </div>
            </div>
            
            <!-- 最近错误 -->
            <div class="col-lg-6">
                <div class="metric-card">
                    <h5><i class="bi bi-bug"></i> 最近错误</h5>
                    <div id="recentErrors">
                        <div class="text-center text-muted">加载中...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentTimeRange = '1h';
        let orderTrendChart = null;
        let refreshInterval = null;
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadRealtimeData();
            startAutoRefresh();
        });
        
        // 初始化图表
        function initializeCharts() {
            const ctx = document.getElementById('orderTrendChart').getContext('2d');
            orderTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '订单数',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }
        
        // 加载实时数据
        function loadRealtimeData() {
            showRefreshIndicator();
            
            fetch(`/admin/monitor/realtime-data?time_range=${currentTimeRange}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 0) {
                        updateDashboard(data.data);
                    } else {
                        console.error('获取监控数据失败:', data.msg);
                    }
                })
                .catch(error => {
                    console.error('请求失败:', error);
                })
                .finally(() => {
                    hideRefreshIndicator();
                    updateLastUpdateTime();
                });
        }
        
        // 更新仪表板数据
        function updateDashboard(data) {
            // 更新订单统计
            updateMetric('totalOrders', data.order_stats.total_orders);
            updateMetric('paidOrders', data.order_stats.paid_orders);
            updateMetric('conversionRate', data.order_stats.conversion_rate);
            updateMetric('totalAmount', '¥' + data.order_stats.total_amount.toLocaleString());
            
            // 更新系统健康状态
            updateSystemHealth(data.system_health);
            
            // 更新预警信息
            updateAlerts(data.alerts);
            
            // 更新最近错误
            updateRecentErrors(data.recent_errors);
            
            // 加载趋势数据
            loadTrendData();
        }
        
        // 更新指标
        function updateMetric(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
            }
        }
        
        // 更新系统健康状态
        function updateSystemHealth(health) {
            updateHealthIndicator('overallStatus', health.overall_status);
            updateHealthIndicator('databaseStatus', health.database.status);
            updateHealthIndicator('redisStatus', health.redis.status);
            updateHealthIndicator('diskStatus', health.disk_space.status);
            updateHealthIndicator('memoryStatus', health.memory_usage.status);
            
            document.getElementById('overallStatusText').textContent = 
                health.overall_status === 'healthy' ? '系统正常' : 
                health.overall_status === 'warning' ? '系统警告' : '系统异常';
        }
        
        // 更新健康指示器
        function updateHealthIndicator(elementId, status) {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = `health-indicator ${status}`;
            }
        }
        
        // 更新预警信息
        function updateAlerts(alerts) {
            const container = document.getElementById('alertsList');
            if (alerts.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">暂无活跃预警</div>';
                return;
            }
            
            container.innerHTML = alerts.map(alert => `
                <div class="alert-item ${alert.level}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${alert.title}</strong>
                            <div class="mt-1">${alert.message}</div>
                        </div>
                        <small class="text-muted">${alert.created_at}</small>
                    </div>
                </div>
            `).join('');
        }
        
        // 更新最近错误
        function updateRecentErrors(errors) {
            const container = document.getElementById('recentErrors');
            if (errors.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">暂无错误</div>';
                return;
            }
            
            container.innerHTML = errors.map(error => `
                <div class="error-item">
                    <div class="error-message">${error.node}</div>
                    <div class="error-time">${error.created_at}</div>
                </div>
            `).join('');
        }
        
        // 加载趋势数据
        function loadTrendData() {
            fetch(`/admin/monitor/trend-data?type=orders&time_range=${currentTimeRange}&granularity=hour`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 0) {
                        updateTrendChart(data.data);
                    }
                })
                .catch(error => {
                    console.error('获取趋势数据失败:', error);
                });
        }
        
        // 更新趋势图表
        function updateTrendChart(data) {
            if (orderTrendChart) {
                orderTrendChart.data.labels = data.map(item => {
                    const date = new Date(item.timestamp * 1000);
                    return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                });
                orderTrendChart.data.datasets[0].data = data.map(item => item.count);
                orderTrendChart.update();
            }
        }
        
        // 改变时间范围
        function changeTimeRange(timeRange) {
            currentTimeRange = timeRange;
            loadRealtimeData();
        }
        
        // 开始自动刷新
        function startAutoRefresh() {
            refreshInterval = setInterval(loadRealtimeData, 30000); // 30秒刷新一次
        }
        
        // 停止自动刷新
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
        
        // 显示刷新指示器
        function showRefreshIndicator() {
            document.getElementById('refreshIndicator').style.display = 'block';
        }
        
        // 隐藏刷新指示器
        function hideRefreshIndicator() {
            document.getElementById('refreshIndicator').style.display = 'none';
        }
        
        // 更新最后更新时间
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `最后更新：${now.toLocaleTimeString('zh-CN')}`;
        }
        
        // 页面失去焦点时停止自动刷新，获得焦点时重新开始
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
                loadRealtimeData(); // 立即刷新一次
            }
        });
        
        // 页面卸载时停止自动刷新
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });
    </script>
    
    <style>
        .spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</body>
</html>




