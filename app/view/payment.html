<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>è®¢å•æ”¯ä»˜ - <?=$subject?></title>
    <script>
        // çœŸå®äºŒç»´ç ç”Ÿæˆæ–¹æ¡ˆï¼ˆä½¿ç”¨å‰ç«¯åº“ï¼Œä¸ä¾èµ–ç¬¬ä¸‰æ–¹APIï¼‰
        function generateRealQRCode() {
            const qrCodeElement = document.getElementById("qrCode");
            const qrCodeUrl = window.location.href;
            
            if (!qrCodeElement) {
                console.error("äºŒç»´ç å®¹å™¨æœªæ‰¾åˆ°");
                return;
            }
            
            // æ¸…ç©ºå®¹å™¨
            qrCodeElement.innerHTML = "";
            
            // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½ QRCode åº“
            if (typeof QRCode === 'undefined') {
                console.error("QRCodeåº“æœªåŠ è½½ï¼Œå°è¯•åŠ è½½...");
                // åŠ¨æ€åŠ è½½ qrcodejs åº“
                const script = document.createElement('script');
                script.src = 'https://cdn.bootcdn.net/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
                script.onerror = function() {
                    // å¦‚æœ bootcdn å¤±è´¥ï¼Œå°è¯• jsdelivr
                    script.src = 'https://cdn.jsdelivr.net/npm/qrcodejs2@0.0.2/qrcode.min.js';
                    script.onerror = function() {
                        console.error("äºŒç»´ç åº“åŠ è½½å¤±è´¥");
                        showFallbackQR();
                    };
                };
                script.onload = function() {
                    generateQRCodeWithLibrary();
                };
                document.head.appendChild(script);
                return;
            }
            
            generateQRCodeWithLibrary();
            
            function generateQRCodeWithLibrary() {
                try {
                    // ä½¿ç”¨ QRCode åº“ç”ŸæˆäºŒç»´ç 
                    qrCodeElement.innerHTML = "";
                    new QRCode(qrCodeElement, {
                        text: qrCodeUrl,
                        width: 180,
                        height: 180,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                    console.log("äºŒç»´ç ç”ŸæˆæˆåŠŸï¼ˆä½¿ç”¨å‰ç«¯åº“ï¼‰");
                } catch (error) {
                    console.error("äºŒç»´ç ç”Ÿæˆå¤±è´¥:", error);
                    showFallbackQR();
                }
            }
            
            function showFallbackQR() {
                console.log("äºŒç»´ç ç”Ÿæˆå¤±è´¥ï¼Œæ˜¾ç¤ºå¤‡ç”¨æ–¹æ¡ˆ");
                qrCodeElement.innerHTML = `
                    <div style="
                        width: 180px;
                        height: 180px;
                        margin: 0 auto;
                        border: 2px dashed #007bff;
                        border-radius: 8px;
                        background: #f8f9fa;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        text-align: center;
                        color: #666;
                    ">
                        <div style="font-size: 24px; margin-bottom: 10px;">ğŸ“±</div>
                        <div style="font-size: 14px; margin-bottom: 5px;">æ‰«ç æ”¯ä»˜</div>
                        <div style="font-size: 10px; color: #999;">äºŒç»´ç ç”Ÿæˆå¤±è´¥</div>
                    </div>
                `;
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåç”ŸæˆçœŸå®äºŒç»´ç ï¼ˆä»…åœ¨æ‰«ç æ”¯ä»˜å¼€å¯æ—¶ï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            <?php if ($scanPayEnabled): ?>
            // é¢„åŠ è½½äºŒç»´ç åº“
            const qrcodeScript = document.createElement('script');
            qrcodeScript.src = 'https://cdn.bootcdn.net/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
            qrcodeScript.onerror = function() {
                // å¦‚æœ bootcdn å¤±è´¥ï¼Œå°è¯• jsdelivr
                qrcodeScript.src = 'https://cdn.jsdelivr.net/npm/qrcodejs2@0.0.2/qrcode.min.js';
            };
            qrcodeScript.onload = function() {
                setTimeout(generateRealQRCode, 100);
            };
            document.head.appendChild(qrcodeScript);
            // å¦‚æœè„šæœ¬åŠ è½½è¾ƒæ…¢ï¼Œè®¾ç½®è¶…æ—¶
            setTimeout(function() {
                if (typeof QRCode !== 'undefined') {
                    generateRealQRCode();
                }
            }, 500);
            <?php endif; ?>
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨æ”¯ä»˜ï¼ˆOAuthæˆæƒå®Œæˆåï¼‰
            <?php if ($autoPay): ?>
            console.log("ğŸ¯ OAuthæˆæƒæˆåŠŸï¼Œè‡ªåŠ¨è§¦å‘æ”¯ä»˜");
            
            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            const payButton = document.getElementById('payButton');
            if (payButton) {
                payButton.textContent = 'âœ… æˆæƒæˆåŠŸï¼Œæ­£åœ¨è°ƒèµ·æ”¯ä»˜...';
                payButton.style.background = '#52c41a';
            }
            
            // 1ç§’åè‡ªåŠ¨è§¦å‘æ”¯ä»˜
            setTimeout(function() {
                console.log("ğŸš€ è‡ªåŠ¨è§¦å‘æ”¯ä»˜");
                submitPayment();
            }, 1000);
            <?php endif; ?>
        });
    </script>
    <style>
        * {
            box-sizing: border-box;
        }
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background: #f5f5f5;
            display: flex;
            align-items: stretch;
            justify-content: center;
            height: 100vh;
            height: 100dvh; /* åŠ¨æ€è§†å£é«˜åº¦ï¼Œæ”¯æŒç§»åŠ¨ç«¯æµè§ˆå™¨ */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        .payment-container {
            background: white;
            border-radius: 0;
            box-shadow: none;
            padding: 10px 15px;
            max-width: 100%;
            width: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
            -webkit-tap-highlight-color: transparent;
            /* ç¡®ä¿å®¹å™¨å¡«æ»¡è§†å£ */
            min-height: 100%;
            max-height: 100vh;
            max-height: 100dvh;
        }
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            .payment-container {
                padding: 6px 10px;
                border-radius: 0;
                /* åœ¨ç§»åŠ¨ç«¯ï¼Œå®¹å™¨å¯ä»¥æ»šåŠ¨ï¼Œä½†ç¡®ä¿å†…å®¹ç´§å‡‘ */
            }
        }
        
        /* ç¡®ä¿å†…å®¹åœ¨è§†å£å†…ï¼Œä¸å‡ºç°æ•´ä½“æ»šåŠ¨æ¡ */
        .payment-container::-webkit-scrollbar {
            width: 4px;
        }
        .payment-container::-webkit-scrollbar-track {
            background: transparent;
        }
        .payment-container::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 2px;
        }
        
        /* å®‰å…¨åŒºåŸŸé€‚é…ï¼ˆiPhone X ç­‰å¸¦åˆ˜æµ·å±çš„è®¾å¤‡ï¼‰ */
        @supports (padding: max(0px)) {
            .payment-container {
                padding-left: max(10px, env(safe-area-inset-left));
                padding-right: max(10px, env(safe-area-inset-right));
                padding-top: max(10px, env(safe-area-inset-top));
                padding-bottom: max(10px, env(safe-area-inset-bottom));
            }
        }
        .logo {
            width: 50px;
            height: 50px;
            background: #1677ff;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
            flex-shrink: 0;
        }
        .title {
            font-size: 20px;
            color: #333;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .subtitle {
            color: #666;
            font-size: 12px;
            margin-bottom: 15px;
        }
        .order-info {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: left;
            flex-shrink: 0;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
            line-height: 1.5;
        }
        .order-item:last-child {
            margin-bottom: 0;
            font-weight: bold;
            font-size: 15px;
            color: #1677ff;
            border-top: 1px solid #e0e0e0;
            padding-top: 8px;
            margin-top: 5px;
        }
        .pay-button {
            background: #1677ff;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            flex-shrink: 0;
            touch-action: manipulation; /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        }
        .pay-button:hover {
            background: #4096ff;
            transform: translateY(-2px);
        }
        .pay-button:active {
            transform: translateY(0);
        }
        .loading {
            display: none;
            margin-top: 20px;
        }
        .loading-text {
            color: #666;
            font-size: 14px;
        }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #1677ff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .qr-code-container {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            text-align: center;
            flex-shrink: 0;
        }
        .qr-code-title {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .qr-code {
            width: 160px;
            height: 160px;
            margin: 0 auto 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .qr-code-text {
            font-size: 12px;
            color: #666;
        }
        /* ç§»åŠ¨ç«¯äºŒç»´ç ä¼˜åŒ– */
        @media (max-width: 480px) {
            .qr-code {
                width: 140px;
                height: 140px;
            }
        }
        .countdown-item {
            border-top: 1px solid #e0e0e0;
            padding-top: 8px;
            margin-top: 8px;
        }
        .countdown {
            font-weight: bold;
            color: #ff6b6b;
            font-size: 14px;
        }
        .countdown.warning {
            color: #ff9500;
        }
        .countdown.danger {
            color: #ff3b30;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        .payment-notice {
            background: #fff9e6;
            border: 1px solid #ffd700;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            text-align: left;
            font-size: 12px;
            line-height: 1.6;
            flex-shrink: 0;
        }
        /* ç§»åŠ¨ç«¯é¢å¤–ä¼˜åŒ– */
        @media (max-width: 480px) {
            .logo {
                width: 45px;
                height: 45px;
                font-size: 18px;
                margin-bottom: 8px;
            }
            .title {
                font-size: 18px;
                margin-bottom: 4px;
            }
            .subtitle {
                font-size: 11px;
                margin-bottom: 12px;
            }
            .order-info {
                padding: 10px;
                margin-bottom: 12px;
            }
            .order-item {
                font-size: 12px;
                margin-bottom: 6px;
            }
            .order-item:last-child {
                font-size: 14px;
            }
            .pay-button {
                padding: 12px;
                font-size: 15px;
                margin-bottom: 8px;
            }
            .qr-code-container {
                padding: 10px;
                margin-bottom: 12px;
            }
            .payment-notice {
                padding: 8px;
                font-size: 11px;
                margin-top: 8px;
            }
        }
        .payment-notice-item {
            margin-bottom: 8px;
        }
        .payment-notice-item:last-child {
            margin-bottom: 0;
        }
        .payment-notice-red {
            color: #ff0000;
            font-weight: bold;
        }
        .payment-notice-footer {
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
            color: #ff6b00;
        }
    </style>
</head>
<body>
    <div class="payment-container">
        <div class="logo">æ”¯</div>
        <div class="title">è®¢å•æ”¯ä»˜</div>
        <div class="subtitle">è¯·ç¡®è®¤è®¢å•ä¿¡æ¯åå®Œæˆæ”¯ä»˜</div>
        
        <div class="order-info">
            <div class="order-item">
                <span>è®¢å•å·ï¼š</span>
                <span><?=$orderNo?></span>
            </div>
            <div class="order-item">
                <span>æ”¯ä»˜é‡‘é¢ï¼š</span>
                <span>Â¥<?=$amount?></span>
            </div>
            <div class="order-item countdown-item">
                <span>å‰©ä½™æ—¶é—´ï¼š</span>
                <span id="countdown" class="countdown">è®¡ç®—ä¸­...</span>
            </div>
        </div>
        
        <?php if ($scanPayEnabled): ?>
        <div class="qr-code-container">
            <div class="qr-code-title">æ‰«ç æ”¯ä»˜</div>
            <div class="qr-code" id="qrCode"></div>
            <div class="qr-code-text">è¯·ä½¿ç”¨æ”¯ä»˜å®æ‰«æäºŒç»´ç å®Œæˆæ”¯ä»˜</div>
        </div>
        <?php endif; ?>
        
        <button id="payButton" class="pay-button" onclick="submitPayment()">
            <?php if ($isMobile): ?>
                ğŸ“± ç«‹å³æ”¯ä»˜
            <?php else: ?>
                ğŸ’³ ç«‹å³æ”¯ä»˜
            <?php endif; ?>
        </button>
            
            <!-- æ”¯ä»˜æ³¨æ„äº‹é¡¹ -->
        <div class="payment-notice" style="margin-top: 20px; margin-bottom: 30px;">
                <div class="payment-notice-item">1ã€è¯·å‹¿å¿˜è®°æ”¯ä»˜çš„é‡‘é¢ã€æ—¶é—´ã€å¤‡æ³¨ï¼Œæœ‰äº›ç”¨æˆ·ä»¥å¿˜è®°è´­ä¹°ä»€ä¹ˆäº§å“çš„ç†ç”±å‘èµ·æŠ•è¯‰ï¼Œæ­¤ç±»ç”¨æˆ·ä¸€å¾‹æ°¸ä¹…å°ç¦ã€‚</div>
                <div class="payment-notice-item">2ã€å¯¹äº§å“çš„ä½¿ç”¨æœ‰ç–‘é—®çš„ï¼Œè”ç³»åœ¨çº¿å®¢æœ</div>
                <div class="payment-notice-item payment-notice-red">3ã€å®¢æœå¤„ç†éœ€è¦æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…</div>
                <div class="payment-notice-item payment-notice-red">4ã€éƒ¨åˆ†ä¸æ²Ÿé€šï¼Œç›´æ¥å‘èµ·æŠ•è¯‰çš„ï¼Œå°†æ°¸ä¹…å°ç¦è´¦æˆ·ï¼</div>
                <div class="payment-notice-footer">æ³¨æ„:æ”¯ä»˜ä¿èµ”ä»˜ï¼Œå®‰å…¨ä¿éšœï¼Œæ„Ÿè°¢æ‚¨çš„å‚ä¸!!</div>
            </div>
        
        <!-- ğŸ” è°ƒè¯•æŒ‰é’®ï¼šæŸ¥çœ‹åè®®åœ°å€ï¼ˆå·²æ³¨é‡Šï¼Œéœ€è¦è°ƒè¯•æ—¶å¯å–æ¶ˆæ³¨é‡Šï¼‰ -->
        <!--
        <button onclick="showDebugSchemeUrl()" style="width: 100%; background: #6c757d; color: white; border: none; padding: 15px 30px; font-size: 16px; border-radius: 8px; cursor: pointer; margin-top: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
            ğŸ” æŸ¥çœ‹è°ƒèµ·åè®®åœ°å€ï¼ˆè°ƒè¯•ï¼‰
        </button>
        -->

        
        <!-- è°ƒè¯•ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="debugInfo" style="display: none; background: #1e1e1e; color: #00ff00; padding: 15px; margin: 20px 0; border-radius: 8px; font-family: monospace; font-size: 12px; overflow-x: auto; max-height: 400px; overflow-y: auto;">
            <div style="color: #fff; font-weight: bold; margin-bottom: 10px;">ğŸ” è°ƒè¯•ä¿¡æ¯ï¼ˆæ§åˆ¶å°è¾“å‡ºï¼‰</div>
            <div id="debugContent"></div>
            </div>

        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <div class="loading-text">æ­£åœ¨è·³è½¬åˆ°æ”¯ä»˜å®...</div>
            <div id="jumpUrl" style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.9); border-radius: 8px; font-size: 11px; word-break: break-all; color: #333; display: none; max-width: 90%; text-align: left;"></div>
                </div>
        
        <!-- éšè—çš„æ”¯ä»˜è¡¨å• -->
        <?=$paymentForm?>
                </div>

    <script>
        // ========== è°ƒè¯•ä¿¡æ¯æ”¶é›† ==========
        let debugLogs = [];
        
        // é‡å†™console.logä»¥æ”¶é›†è°ƒè¯•ä¿¡æ¯
        const originalConsoleLog = console.log;
        console.log = function() {
            originalConsoleLog.apply(console, arguments);
            const message = Array.from(arguments).map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            debugLogs.push(message);
        };
        
        // åˆ‡æ¢è°ƒè¯•ä¿¡æ¯æ˜¾ç¤º
        function toggleDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');
            const debugContent = document.getElementById('debugContent');
            
            if (debugInfo.style.display === 'none') {
                debugInfo.style.display = 'block';
                if (debugContent && debugLogs.length > 0) {
                    debugContent.innerHTML = debugLogs.map(log => {
                        const escaped = log.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        return `<div style="margin: 5px 0; padding: 5px; border-bottom: 1px solid #333; word-break: break-all;">${escaped}</div>`;
                    }).join('');
                }
            } else {
                debugInfo.style.display = 'none';
            }
        }
        
        // æ˜¾ç¤ºåè®®åœ°å€å¼¹çª—
        function showSchemeUrlDialog(schemeUrl, oauthUrl, callback) {
            // åˆ›å»ºé®ç½©å±‚
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;
            
            // åˆ›å»ºå¼¹çª—å†…å®¹
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white;
                border-radius: 10px;
                padding: 20px;
                max-width: 90%;
                max-height: 80%;
                overflow-y: auto;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            
            // è½¬ä¹‰schemeUrlä¸­çš„ç‰¹æ®Šå­—ç¬¦
            const escapedUrl = schemeUrl.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
            
            // åˆ¤æ–­æ˜¯ç®€å•æ¨¡å¼è¿˜æ˜¯OAuthæ¨¡å¼
            const isSimpleMode = !oauthUrl.includes('openauth.alipay.com');
            
            let detailsHtml = '';
            
            if (isSimpleMode) {
                // ç®€å•æ¨¡å¼ï¼šç›´æ¥æ‰“å¼€URL
                detailsHtml = `
                    <div style="margin-bottom: 15px; background: #d1ecf1; padding: 15px; border-radius: 8px; border: 2px solid #17a2b8;">
                        <div style="font-weight: bold; color: #0c5460; margin-bottom: 10px;">ğŸ“± APPè°ƒèµ·æµ‹è¯•</div>
                        <div style="margin: 5px 0; font-size: 13px; color: #0c5460;">
                            <strong>ç›®æ ‡åœ°å€:</strong> 
                            <div style="background: white; padding: 8px; border-radius: 4px; margin-top: 5px; word-break: break-all;">
                                <code style="font-weight: bold; color: #0c5460;">${oauthUrl}</code>
                </div>
            </div>
                        <div style="margin-top: 10px; font-size: 13px; color: #0c5460;">
                            <strong>è¯´æ˜ï¼š</strong> æ­¤æ¨¡å¼ç”¨äºæµ‹è¯• alipays:// åè®®è°ƒèµ·åŠŸèƒ½
            </div>
        </div>
                `;
            } else {
                // OAuthæ¨¡å¼ï¼šå®Œæ•´çš„æˆæƒæµç¨‹
                const redirectUriMatch = oauthUrl.match(/redirect_uri=([^&]+)/);
                const redirectUri = redirectUriMatch ? decodeURIComponent(redirectUriMatch[1]) : 'æœªæ‰¾åˆ°';
                const appIdMatch = oauthUrl.match(/app_id=([^&]+)/);
                const appId = appIdMatch ? appIdMatch[1] : 'æœªæ‰¾åˆ°';
                const scopeMatch = oauthUrl.match(/scope=([^&]+)/);
                const scope = scopeMatch ? scopeMatch[1] : 'æœªæ‰¾åˆ°';
                const stateMatch = oauthUrl.match(/state=([^&]+)/);
                const state = stateMatch ? decodeURIComponent(stateMatch[1]) : 'æœªæ‰¾åˆ°';
                
                detailsHtml = `
                    <div style="margin-bottom: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 10px;">ğŸ“‹ OAuthæˆæƒå‚æ•°è¯¦æƒ…ï¼š</div>
                        <div style="margin: 5px 0; font-size: 13px;"><strong>APP ID:</strong> <code style="background: #e9ecef; padding: 2px 6px; border-radius: 3px;">${appId}</code></div>
                        <div style="margin: 5px 0; font-size: 13px;"><strong>Scope:</strong> <code style="background: #e9ecef; padding: 2px 6px; border-radius: 3px;">${scope}</code></div>
                        <div style="margin: 5px 0; font-size: 13px;"><strong>State:</strong> <code style="background: #e9ecef; padding: 2px 6px; border-radius: 3px;">${state}</code></div>
                        <div style="margin: 5px 0; font-size: 13px;">
                            <strong>Redirect URI:</strong> 
                            <div style="background: ${redirectUri.includes('/oauth/callback') ? '#d4edda' : '#f8d7da'}; padding: 8px; border-radius: 4px; margin-top: 5px; word-break: break-all; border: 2px solid ${redirectUri.includes('/oauth/callback') ? '#28a745' : '#dc3545'};">
                                <code style="font-weight: bold; color: ${redirectUri.includes('/oauth/callback') ? '#155724' : '#721c24'};">${redirectUri}</code>
                                ${redirectUri.includes('/oauth/callback') ? ' âœ… æ­£ç¡®' : ' âš ï¸ åœ°å€ä¸æ­£ç¡®ï¼'}
                </div>
                        </div>
                    </div>
                `;
            }
            
            dialog.innerHTML = `
                <h3 style="margin: 0 0 15px 0; color: #333; font-size: 18px;">ğŸš€ è°ƒèµ·æ”¯ä»˜å®APPçš„å®Œæ•´åè®®åœ°å€</h3>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: bold; color: #666; margin-bottom: 5px;">ğŸ“± Alipays Scheme URL:</div>
                    <textarea id="schemeUrlTextarea" readonly style="width: 100%; height: 120px; padding: 10px; border: 2px solid #007bff; border-radius: 5px; font-size: 12px; font-family: monospace; resize: vertical;">${schemeUrl}</textarea>
                    <button id="copyBtn" style="margin-top: 5px; background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">ğŸ“‹ å¤åˆ¶å®Œæ•´åœ°å€</button>
            </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: bold; color: #666; margin-bottom: 5px;">ğŸŒ ${isSimpleMode ? 'ç›®æ ‡URL' : 'OAuthæˆæƒURL'} (è§£ç å):</div>
                    <textarea readonly style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 12px; font-family: monospace; resize: vertical;">${oauthUrl}</textarea>
        </div>
        
                ${detailsHtml}
                
                <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #ffc107;">
                    <strong>ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
                    1. ä¸Šé¢æ˜¾ç¤ºçš„æ˜¯å®Œæ•´çš„è°ƒèµ·åœ°å€<br>
                    2. ç‚¹å‡»"ç»§ç»­"åä¼šè‡ªåŠ¨è°ƒèµ·æ”¯ä»˜å®APP<br>
                    3. ${isSimpleMode ? 'APPå°†ä¼šæ‰“å¼€æŒ‡å®šé¡µé¢' : 'æˆæƒæˆåŠŸåä¼šè¿”å›æ”¯ä»˜é¡µé¢ï¼Œå¹¶è‡ªåŠ¨å®Œæˆæ”¯ä»˜'}
    </div>

                <button id="continueBtn" style="width: 100%; background: #28a745; color: white; border: none; padding: 12px; border-radius: 5px; font-size: 16px; cursor: pointer;">âœ… æˆ‘çŸ¥é“äº†ï¼Œç»§ç»­è°ƒèµ·APP</button>
            `;
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            // å¤åˆ¶æŒ‰é’®äº‹ä»¶
            const copyBtn = dialog.querySelector('#copyBtn');
            copyBtn.addEventListener('click', function() {
                const textarea = dialog.querySelector('#schemeUrlTextarea');
                copyToClipboard(textarea.value, copyBtn);
            });
            
            // ç»§ç»­æŒ‰é’®äº‹ä»¶
            const continueBtn = dialog.querySelector('#continueBtn');
            continueBtn.addEventListener('click', function() {
                overlay.remove();
                if (callback) callback();
            });
            
            // ç‚¹å‡»é®ç½©å±‚å…³é—­
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
        }
        
        // è°ƒè¯•ï¼šæ‰‹åŠ¨æŸ¥çœ‹åè®®åœ°å€
        function showDebugSchemeUrl() {
            // ğŸ§ª æµ‹è¯•æ–¹æ¡ˆé€‰æ‹©
            const TEST_MODE = 2;  // 1=ç›´æ¥è·³ç™¾åº¦, 2=OAuthæˆæƒæµç¨‹
            
            let targetUrl, alipayAuthUrl;
            
            if (TEST_MODE === 1) {
                // æ–¹æ¡ˆ1: ç®€å•æµ‹è¯•ï¼ˆç›´æ¥æ‰“å¼€å½“å‰é¡µé¢ï¼‰
                const currentUrl = window.location.href.split('?')[0];
                const orderNumber = "<?= $orderNo ?>";
                targetUrl = `${currentUrl}?order_number=${orderNumber}`;
                alipayAuthUrl = `alipays://platformapi/startapp?appId=20000067&url=${encodeURIComponent(targetUrl)}`;
                
                console.log("ğŸ§ª æµ‹è¯•æ¨¡å¼1: ç®€å•æµ‹è¯•");
                console.log("Target URL:", targetUrl);
                console.log("Alipays Scheme:", alipayAuthUrl);
                
            } else {
                // æ–¹æ¡ˆ2: å®Œæ•´çš„OAuthæˆæƒæµç¨‹
                // ä½¿ç”¨æ§åˆ¶å™¨ä¼ é€’çš„oauthAppIdï¼ˆä¼˜å…ˆä½¿ç”¨.envä¸­çš„æˆæƒä¸“ç”¨AppIDï¼‰
                const appId = "<?= $oauthAppId ?? ($subjectObj->alipay_app_id ?? '') ?>";
                const scope = "auth_base";
                const orderNumber = "<?= $orderNo ?>";
                // ä½¿ç”¨ä¸“é—¨çš„OAuthå›è°ƒè·¯ç”±
                const baseUrl = window.location.origin;
                const fullRedirectUrl = `${baseUrl}/oauth/callback`;
                const redirectUri = encodeURIComponent(fullRedirectUrl);
                const state = orderNumber;
                
                targetUrl = `https://openauth.alipay.com/oauth2/publicAppAuthorize.htm?app_id=${appId}&scope=${scope}&redirect_uri=${redirectUri}&state=${state}`;
                alipayAuthUrl = `alipays://platformapi/startapp?appId=20000067&url=${encodeURIComponent(targetUrl)}`;
                
                console.log("OAuthæˆæƒæµç¨‹");
                console.log("OAuth URL:", targetUrl);
                console.log("Alipays Scheme:", alipayAuthUrl);
            }
            
            // æ˜¾ç¤ºå¼¹çª—ï¼ˆä¸è‡ªåŠ¨è·³è½¬ï¼‰
            showSchemeUrlDialog(alipayAuthUrl, targetUrl, null);
        }
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text, button) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    const originalText = button.textContent;
                    button.textContent = 'âœ… å·²å¤åˆ¶ï¼';
                    button.style.background = '#28a745';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '#007bff';
                    }, 2000);
                }).catch(err => {
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                });
            } else {
                // é™çº§æ–¹æ¡ˆ
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    button.textContent = 'âœ… å·²å¤åˆ¶ï¼';
                    button.style.background = '#28a745';
                    setTimeout(() => {
                        button.textContent = 'ğŸ“‹ å¤åˆ¶å®Œæ•´åœ°å€';
                        button.style.background = '#007bff';
                    }, 2000);
                } catch (err) {
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                }
                document.body.removeChild(textarea);
            }
        }
        // ====================================
        
        function submitPayment() {
            // è·å–å…ƒç´ å¼•ç”¨ï¼ˆä¾›é”™è¯¯å¤„ç†ä½¿ç”¨ï¼‰
            const payButton = document.getElementById("payButton");
            const loading = document.getElementById("loading");
            
            // è®¾å¤‡ä¿¡æ¯æ‰“å°ï¼ˆå·²æ³¨é‡Šï¼Œéœ€è¦è°ƒè¯•æ—¶å¯å–æ¶ˆæ³¨é‡Šï¼‰
            // console.log("========== ç‚¹å‡»ç«‹å³æ”¯ä»˜ ==========");
            // console.log("è®¾å¤‡ç±»å‹: <?= $isMobile ? 'ç§»åŠ¨è®¾å¤‡' : 'PCè®¾å¤‡' ?>");
            // console.log("æ˜¯å¦æ”¯ä»˜å®æµè§ˆå™¨: <?= $isAlipay ? 'true' : 'false' ?>");
            // console.log("æ˜¯å¦å¾®ä¿¡æµè§ˆå™¨: <?= $isWeChat ? 'true' : 'false' ?>");
            // console.log("éœ€è¦OAuth: <?= $needOAuth ? 'true' : 'false' ?>");
            // console.log("å·²æœ‰buyer_id: <?= $hasBuyerId ? 'true' : 'false' ?>");
            // console.log("====================================");
            
            <?php if ($isMobile): ?>
            <?php if ($isAlipay): ?>
            // æ”¯ä»˜å®æµè§ˆå™¨ï¼šç›´æ¥è·³è½¬ï¼ˆä¸æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼Œé¿å…DOMé‡ç»˜å»¶è¿Ÿï¼‰
            
            // OAuthæˆæƒæµç¨‹
            const TEST_MODE = 2;  // 1=ç›´æ¥è·³ç™¾åº¦, 2=OAuthæˆæƒæµç¨‹
            
            let targetUrl;
            if (TEST_MODE === 1) {
                const currentUrl = window.location.href.split('?')[0];
                const orderNumber = "<?= $orderNo ?>";
                targetUrl = `${currentUrl}?order_number=${orderNumber}`;
                console.log("ğŸ§ª æµ‹è¯•æ¨¡å¼1: ç®€å•æµ‹è¯•");
            } else {
                // æ–¹æ¡ˆ2: å®Œæ•´çš„OAuthæˆæƒæµç¨‹
                // ä½¿ç”¨æ§åˆ¶å™¨ä¼ é€’çš„oauthAppIdï¼ˆä¼˜å…ˆä½¿ç”¨.envä¸­çš„æˆæƒä¸“ç”¨AppIDï¼‰
                const appId = "<?= $oauthAppId ?? ($subjectObj->alipay_app_id ?? '') ?>";
                const scope = "auth_base";
                const orderNumber = "<?= $orderNo ?>";
                // ä½¿ç”¨ä¸“é—¨çš„OAuthå›è°ƒè·¯ç”±
                const baseUrl = window.location.origin;
                const fullRedirectUrl = `${baseUrl}/oauth/callback`;
                const redirectUri = encodeURIComponent(fullRedirectUrl);
                const state = orderNumber;
                targetUrl = `https://openauth.alipay.com/oauth2/publicAppAuthorize.htm?app_id=${appId}&scope=${scope}&redirect_uri=${redirectUri}&state=${state}`;
                console.log("OAuthæˆæƒæµç¨‹ï¼Œæˆæƒåå°†è¿”å›æ”¯ä»˜é¡µé¢");
            }
            
            
            // ğŸš€ ç«‹å³è·³è½¬åˆ°ç›®æ ‡URLï¼ˆç§»é™¤å»¶è¿Ÿï¼‰
            window.location.href = targetUrl;
            <?php elseif ($isWeChat): ?>
            // å¾®ä¿¡æµè§ˆå™¨ï¼šæç¤ºç”¨æˆ·ç”¨å¤–éƒ¨æµè§ˆå™¨æ‰“å¼€
            // console.log("å¾®ä¿¡æµè§ˆå™¨ï¼Œæç¤ºå¤–éƒ¨æµè§ˆå™¨æ‰“å¼€");
            alert("æ£€æµ‹åˆ°å¾®ä¿¡æµè§ˆå™¨ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’èœå•ï¼Œé€‰æ‹©\"åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€\"æ¥å®Œæˆæ”¯ä»˜ï¼");
            <?php else: ?>
            // å…¶ä»–ç§»åŠ¨ç«¯æµè§ˆå™¨ï¼šå°è¯•è°ƒèµ·æ”¯ä»˜å®APP
            // console.log("ç§»åŠ¨ç«¯æµè§ˆå™¨ï¼Œå°è¯•è°ƒèµ·æ”¯ä»˜å®APP");
            
            // ç«‹å³æ‰§è¡Œï¼Œç§»é™¤å»¶è¿Ÿ
            try {
                const needOAuth = <?= $needOAuth ? 'true' : 'false' ?>;
                const hasBuyerId = <?= $hasBuyerId ? 'true' : 'false' ?>;
                // console.log("OAuthçŠ¶æ€:", { needOAuth, hasBuyerId });
                    
                // å¦‚æœéœ€è¦OAuthæˆæƒ
                if (needOAuth) {
                    // console.log("éœ€è¦OAuthæˆæƒï¼Œè°ƒèµ·æ”¯ä»˜å®APPè·³è½¬åˆ°æˆæƒé¡µé¢");
                    
                    // OAuthæˆæƒæµç¨‹ï¼ˆä¸è°ƒè¯•æŒ‰é’®ä¿æŒä¸€è‡´ï¼‰
                    const TEST_MODE = 2;  // 1=ç›´æ¥è·³ç™¾åº¦, 2=OAuthæˆæƒæµç¨‹
                    
                    let targetUrl;
                    
                    if (TEST_MODE === 1) {
                        // æ–¹æ¡ˆ1: ç®€å•æµ‹è¯•ï¼ˆç›´æ¥æ‰“å¼€å½“å‰é¡µé¢ï¼‰
                        const currentUrl = window.location.href.split('?')[0];
                        const orderNumber = "<?= $orderNo ?>";
                        targetUrl = `${currentUrl}?order_number=${orderNumber}`;
                        console.log("ğŸ§ª æµ‹è¯•æ¨¡å¼1: ç®€å•æµ‹è¯•");
                        console.log("Target URL:", targetUrl);
                        
                    } else {
                        // æ–¹æ¡ˆ2: å®Œæ•´çš„OAuthæˆæƒæµç¨‹
                        // ä½¿ç”¨æ§åˆ¶å™¨ä¼ é€’çš„oauthAppIdï¼ˆä¼˜å…ˆä½¿ç”¨.envä¸­çš„æˆæƒä¸“ç”¨AppIDï¼‰
                        const appId = "<?= $oauthAppId ?? ($subjectObj->alipay_app_id ?? '') ?>";
                        const scope = "auth_base";
                        const orderNumber = "<?= $orderNo ?>";
                            // ä½¿ç”¨ä¸“é—¨çš„OAuthå›è°ƒè·¯ç”±
                            const baseUrl = window.location.origin;
                            const fullRedirectUrl = `${baseUrl}/oauth/callback`;
                            const redirectUri = encodeURIComponent(fullRedirectUrl);
                            const state = orderNumber;
                            
                            targetUrl = `https://openauth.alipay.com/oauth2/publicAppAuthorize.htm?app_id=${appId}&scope=${scope}&redirect_uri=${redirectUri}&state=${state}`;
                            console.log("OAuthæˆæƒæµç¨‹ï¼Œæˆæƒåå°†è¿”å›æ”¯ä»˜é¡µé¢");
                            console.log("OAuth URL:", targetUrl);
                        }
                        
                        const oauthBaseUrl = targetUrl;
                        
                        // ğŸ§ª æµ‹è¯•å¤šç§æ–¹æ¡ˆ
                        
                        // æ–¹æ¡ˆ1: ä½¿ç”¨20000067ï¼ˆé€šç”¨æµè§ˆå™¨appIdï¼‰- å½“å‰ä½¿ç”¨
                        const alipayAuthUrl1 = `alipays://platformapi/startapp?appId=20000067&url=${encodeURIComponent(oauthBaseUrl)}`;
                        
                        // æ–¹æ¡ˆ2: æµè§ˆå™¨ç›´æ¥è·³è½¬ï¼ˆä¸è°ƒèµ·APPï¼‰
                        const alipayAuthUrl2 = oauthBaseUrl;
                        
                        // æ–¹æ¡ˆ3: ä½¿ç”¨æ”¯ä»˜å®çš„å¦ä¸€ä¸ªscheme
                        const alipayAuthUrl3 = `alipay://platformapi/startapp?appId=20000067&url=${encodeURIComponent(oauthBaseUrl)}`;
                        
                        // æ–¹æ¡ˆ4: ä¸å¸¦appIdå‚æ•°
                        const alipayAuthUrl4 = `alipays://platformapi/startapp?url=${encodeURIComponent(oauthBaseUrl)}`;
                        
                        // ğŸ”§ åˆ‡æ¢è¿™é‡Œæ¥æµ‹è¯•ä¸åŒæ–¹æ¡ˆï¼ˆ1-4ï¼‰
                        const TEST_SCHEME = 1;  // æ–¹æ¡ˆ1ï¼šä½¿ç”¨alipaysåè®®
                        
                        let alipayAuthUrl;
                        switch(TEST_SCHEME) {
                            case 1: alipayAuthUrl = alipayAuthUrl1; break;
                            case 2: alipayAuthUrl = alipayAuthUrl2; break;
                            case 3: alipayAuthUrl = alipayAuthUrl3; break;
                            case 4: alipayAuthUrl = alipayAuthUrl4; break;
                            default: alipayAuthUrl = alipayAuthUrl2;
                        }

                        // è®¾å¤‡ä¿¡æ¯æ‰“å°ï¼ˆå·²æ³¨é‡Šï¼Œéœ€è¦è°ƒè¯•æ—¶å¯å–æ¶ˆæ³¨é‡Šï¼‰
                        // console.log("========== OAuthæˆæƒè°ƒèµ·ï¼ˆè¯¦ç»†åˆ†æï¼‰==========");
                        // console.log("ğŸ§ª æµ‹è¯•æ¨¡å¼ï¼š" + (TEST_MODE === 1 ? "ç›´æ¥æ‰“å¼€ç™¾åº¦" : "OAuthæˆæƒæµç¨‹"));
                        // console.log("ğŸ“Œ å½“å‰ä½¿ç”¨åè®®æ–¹æ¡ˆï¼š" + TEST_SCHEME);
                        // console.log("");
                        // console.log("æµ‹è¯•æ¨¡å¼è¯´æ˜ï¼š");
                        // console.log("  TEST_MODE = 1: ç›´æ¥åœ¨APPå†…æ‰“å¼€ç™¾åº¦ç½‘é¡µ âœ… å½“å‰");
                        // console.log("  TEST_MODE = 2: å®Œæ•´çš„OAuthæˆæƒæµç¨‹");
                        // console.log("");
                        // console.log("åè®®æ–¹æ¡ˆè¯´æ˜ï¼š");
                        // console.log("  æ–¹æ¡ˆ1: alipays://platformapi/startapp?appId=20000067&url=... âœ… å½“å‰");
                        // console.log("  æ–¹æ¡ˆ2: æµè§ˆå™¨ç›´æ¥è·³è½¬ï¼ˆä¸è°ƒèµ·APPï¼‰");
                        // console.log("  æ–¹æ¡ˆ3: alipay://platformapi/startapp?appId=20000067&url=...");
                        // console.log("  æ–¹æ¡ˆ4: alipays://platformapi/startapp?url=...");
                        // console.log("");
                        // console.log("ğŸš€ å‡†å¤‡è·³è½¬åˆ°æ”¯ä»˜å®APP");
                        if (TEST_MODE === 1) {
                            // console.log("æ­¥éª¤1ï¸âƒ£ï¼šç›®æ ‡URL");
                            // console.log("  ğŸŒ ç›´æ¥æ‰“å¼€:", oauthBaseUrl);
                        } else {
                            // console.log("æ­¥éª¤1ï¸âƒ£ï¼šåŸºç¡€å‚æ•°");
                            // console.log("  ğŸ“± APP ID: (åœ¨TEST_MODE=2æ—¶æ˜¾ç¤º)");
                            // console.log("  ğŸ” Scope: auth_base");
                            // console.log("");
                            // console.log("æ­¥éª¤2ï¸âƒ£ï¼šOAuthæˆæƒURL");
                            // console.log("  ğŸŒ OAuth Base URL:");
                            // console.log("     ", oauthBaseUrl);
                        }
                        // console.log("");
                        // console.log("æ­¥éª¤2ï¸âƒ£ï¼šè°ƒèµ·æ”¯ä»˜å®APP");
                        // console.log("  ğŸš€ Alipay Scheme URL:");
                        // console.log("     ", alipayAuthUrl);
                        // console.log("");
                        // console.log("æ­¥éª¤3ï¸âƒ£ï¼šURLè§£ç éªŒè¯");
                        const urlParam = alipayAuthUrl.split('&url=')[1] || alipayAuthUrl.split('?url=')[1];
                        if (urlParam) {
                            // console.log("  ğŸ”“ è§£ç åçš„ç›®æ ‡URL:");
                            // console.log("     ", decodeURIComponent(urlParam));
                        }
                        // console.log("");
                        // console.log("æ­¥éª¤4ï¸âƒ£ï¼šæµ‹è¯•è¯´æ˜");
                        // console.log("  ğŸ¯ æ“ä½œæ­¥éª¤ï¼š");
                        // console.log("     1. ç‚¹å‡»æ”¯ä»˜æŒ‰é’®");
                        if (TEST_MODE === 1) {
                            // console.log("     2. æ”¯ä»˜å®APPåº”è¯¥ä¼šç›´æ¥æ‰“å¼€ç™¾åº¦ç½‘é¡µ");
                            // console.log("     3. éªŒè¯APPå†…æ˜¯å¦èƒ½æ­£å¸¸æ˜¾ç¤ºç™¾åº¦");
                        } else {
                            // console.log("     2. è·³è½¬åˆ°æ”¯ä»˜å®APPè¿›è¡ŒOAuthæˆæƒ");
                            // console.log("     3. æˆæƒæˆåŠŸåä¼šè·³è½¬åˆ°ç™¾åº¦");
                            // console.log("     4. æŸ¥çœ‹ç™¾åº¦åœ°å€æ çš„auth_codeå‚æ•°");
                        }
                        // console.log("");
                        // console.log("ğŸ“‹ å¯ä»¥ç›´æ¥åœ¨æ‰‹æœºæµè§ˆå™¨åœ°å€æ è¾“å…¥ä¸Šé¢çš„alipaysåœ°å€è¿›è¡Œæµ‹è¯•");
                        // console.log("====================================");
                        // console.log("");
                        // console.log("âš¡ å³å°†è·³è½¬åˆ°:", alipayAuthUrl);
                        // console.log("");
                        
                        // ğŸ“º åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºå³å°†è·³è½¬çš„URL
                        const jumpUrlDiv = document.getElementById('jumpUrl');
                        // console.log("ğŸš€ ç«‹å³è·³è½¬åˆ°:", alipayAuthUrl);
                        
                        // ğŸš€ ç«‹å³è·³è½¬ï¼ˆç§»é™¤å»¶è¿Ÿï¼‰
                        window.location.href = alipayAuthUrl;
                        return;
                    }
                    
                    // å·²æœ‰buyer_idï¼Œç›´æ¥æ”¯ä»˜
                    // console.log("å·²æœ‰buyer_idï¼Œå‡†å¤‡è°ƒèµ·æ”¯ä»˜");
                    
                    // è·å–æ”¯ä»˜è¡¨å•
                    const form = document.forms["alipaysubmit"];
                    if (!form) {
                        console.error("æœªæ‰¾åˆ°æ”¯ä»˜è¡¨å•");
                        alert("æ”¯ä»˜è¡¨å•ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°åŠ è½½é¡µé¢");
                        payButton.style.display = "block";
                        loading.style.display = "none";
                        return;
                    }
                    
                    // æå–è¡¨å•action URL
                    const actionUrl = form.getAttribute('action');
                    // console.log("æ”¯ä»˜è¡¨å•URL:", actionUrl);
                    
                    if (actionUrl) {
                        // ä½¿ç”¨æ”¯ä»˜å®åè®®è°ƒèµ·APPå¹¶åœ¨APPå†…æ‰“å¼€æ”¯ä»˜é¡µé¢
                        const alipayScheme = 'alipays://platformapi/startapp?appId=20000067&url=' + encodeURIComponent(actionUrl);
                        
                        // è®¾å¤‡ä¿¡æ¯æ‰“å°ï¼ˆå·²æ³¨é‡Šï¼Œéœ€è¦è°ƒè¯•æ—¶å¯å–æ¶ˆæ³¨é‡Šï¼‰
                        // console.log("========== æ”¯ä»˜è°ƒèµ· ==========");
                        // console.log("ğŸ’° æ”¯ä»˜ç½‘å…³URL:");
                        // console.log(actionUrl);
                        // console.log("");
                        // console.log("ğŸš€ è°ƒèµ·æ”¯ä»˜å®APPçš„å®Œæ•´åœ°å€:");
                        // console.log(alipayScheme);
                        // console.log("");
                        // console.log("ğŸ“‹ å¯ä»¥ç›´æ¥åœ¨æ‰‹æœºæµè§ˆå™¨åœ°å€æ è¾“å…¥ä¸Šé¢çš„alipaysåœ°å€è¿›è¡Œæµ‹è¯•");
                        // console.log("====================================");
                        
                        // è®°å½•é¡µé¢å¯è§çŠ¶æ€
                        let pageHidden = false;
                        let appLaunched = false;
                        
                        // ç›‘å¬é¡µé¢éšè—äº‹ä»¶ï¼ˆAPPè¢«è°ƒèµ·ï¼‰
                        const visibilityHandler = function() {
                            if (document.hidden) {
                                pageHidden = true;
                                appLaunched = true;
                                console.log("APPå·²è¢«è°ƒèµ·ï¼Œé¡µé¢éšè—");
                                // APPå·²è°ƒèµ·ï¼Œç§»é™¤ç›‘å¬å™¨
                                document.removeEventListener('visibilitychange', visibilityHandler);
                                window.removeEventListener('blur', blurHandler);
                            }
                        };
                        document.addEventListener('visibilitychange', visibilityHandler);
                        
                        // è®°å½•çª—å£å¤±å»ç„¦ç‚¹ï¼ˆç”¨æˆ·å¯èƒ½åˆ‡æ¢åˆ°äº†APPï¼‰
                        const blurHandler = function() {
                            console.log("çª—å£å¤±å»ç„¦ç‚¹ï¼Œå¯èƒ½å·²åˆ‡æ¢åˆ°APP");
                        };
                        window.addEventListener('blur', blurHandler);
                        
                        // å°è¯•è°ƒèµ·APP
                        window.location.href = alipayScheme;
                        
                        // ç­‰å¾…3ç§’ï¼Œæ£€æŸ¥APPæ˜¯å¦è¢«è°ƒèµ·
                        setTimeout(function() {
                            // å¦‚æœAPPæ²¡è¢«è°ƒèµ·ï¼Œæç¤ºç”¨æˆ·
                            if (!appLaunched && !pageHidden) {
                                console.log("APPè°ƒèµ·å¤±è´¥ï¼Œæç¤ºç”¨æˆ·");
                                alert("æ— æ³•è°ƒèµ·æ”¯ä»˜å®APPï¼Œè¯·ç¡®ä¿å·²å®‰è£…æ”¯ä»˜å®APPå¹¶é‡è¯•ï¼Œæˆ–ä½¿ç”¨å…¶ä»–æ”¯ä»˜æ–¹å¼ã€‚");
                                document.removeEventListener('visibilitychange', visibilityHandler);
                                window.removeEventListener('blur', blurHandler);
                                payButton.style.display = "block";
                                loading.style.display = "none";
                            } else {
                                console.log("APPå·²è¢«è°ƒèµ·");
                            }
                        }, 3000);
                        
                    } else {
                        // å¦‚æœæ²¡æœ‰action URLï¼Œæç¤ºé”™è¯¯
                        console.log("æœªæ‰¾åˆ°action URL");
                        alert("æ”¯ä»˜è¡¨å•é…ç½®é”™è¯¯ï¼Œè¯·è”ç³»å®¢æœ");
                        payButton.style.display = "block";
                        loading.style.display = "none";
                    }
                    
            } catch (error) {
                console.error("æ”¯ä»˜å¤„ç†å¤±è´¥:", error);
                alert("æ”¯ä»˜å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•");
                payButton.style.display = "block";
                loading.style.display = "none";
            }
            <?php endif; ?>
            <?php else: ?>
            // æ¡Œé¢ç«¯ï¼šç›´æ¥æäº¤è¡¨å•
            setTimeout(function() {
                try {
                    const form = document.forms["alipaysubmit"];
                    if (form) {
                        form.submit();
                    } else {
                        console.error("æœªæ‰¾åˆ°æ”¯ä»˜è¡¨å•");
                        alert("æ”¯ä»˜è¡¨å•ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°åŠ è½½é¡µé¢");
                        payButton.style.display = "block";
                        loading.style.display = "none";
                    }
                } catch (error) {
                    console.error("æ”¯ä»˜è¡¨å•æäº¤å¤±è´¥:", error);
                    alert("æ”¯ä»˜è¡¨å•æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•");
                    payButton.style.display = "block";
                    loading.style.display = "none";
                }
            }, 500);
            <?php endif; ?>
        }
        
        // æµ‹è¯•ç§»åŠ¨ç«¯æ£€æµ‹
        function testMobileDetection() {
            const userAgent = navigator.userAgent;
            const mobileKeywords = [
                'Mobile', 'Android', 'iPhone', 'iPad', 'iPod', 
                'BlackBerry', 'Windows Phone', 'Opera Mini',
                'Safari', 'Chrome Mobile', 'Firefox Mobile'
            ];
            
            let isMobile = false;
            let matchedKeywords = [];
            
            for (let keyword of mobileKeywords) {
                if (userAgent.toLowerCase().includes(keyword.toLowerCase())) {
                    isMobile = true;
                    matchedKeywords.push(keyword);
                }
            }
            
            const result = `
                <div style="font-size: 14px;">
                    <div><strong>User Agent:</strong> ${userAgent}</div>
                    <div><strong>ç§»åŠ¨ç«¯æ£€æµ‹:</strong> <span style="color: ${isMobile ? 'green' : 'red'}">${isMobile ? 'âœ… æ˜¯' : 'âŒ å¦'}</span></div>
                    <div><strong>åŒ¹é…å…³é”®è¯:</strong> ${matchedKeywords.length > 0 ? matchedKeywords.join(', ') : 'æ— '}</div>
                    <div><strong>å±å¹•ä¿¡æ¯:</strong> ${window.screen.width}x${window.screen.height}</div>
                    <div><strong>çª—å£ä¿¡æ¯:</strong> ${window.innerWidth}x${window.innerHeight}</div>
                </div>
            `;
            
            document.getElementById('testResult').innerHTML = result;
            document.getElementById('testResult').style.display = 'block';
        }
        
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(function() {
                    alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                });
            } else {
                // å¤‡ç”¨æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }
        }
        
        
        // ç”ŸæˆäºŒç»´ç ï¼ˆä½¿ç”¨çœŸå®äºŒç»´ç APIï¼‰
        function generateQRCode() {
            generateRealQRCode();
        }
        
        // å€’è®¡æ—¶åŠŸèƒ½
        function startCountdown() {
            const countdownElement = document.getElementById("countdown");
            if (!countdownElement) {
                console.error("å€’è®¡æ—¶å…ƒç´ æœªæ‰¾åˆ°");
                return;
            }
            
            // è·å–è®¢å•è¿‡æœŸæ—¶é—´
            const expireTime = <?=$expireTime?>; // è®¢å•è¿‡æœŸæ—¶é—´æˆ³
            const currentTime = Math.floor(Date.now() / 1000); // å½“å‰æ—¶é—´æˆ³
            let timeLeft = Math.max(0, expireTime - currentTime); // å‰©ä½™æ—¶é—´ï¼ˆç§’ï¼‰
            
            console.log("è®¢å•è¿‡æœŸæ—¶é—´:", new Date(expireTime * 1000).toLocaleString());
            console.log("å½“å‰æ—¶é—´:", new Date(currentTime * 1000).toLocaleString());
            console.log("å‰©ä½™æ—¶é—´:", timeLeft, "ç§’");
            
            // å£°æ˜timerå˜é‡
            let timer;
            let expired = false; // é˜²æ­¢é‡å¤å¼¹å‡ºè¿‡æœŸæç¤º
            
            function updateCountdown() {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                
                // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
                const timeString = minutes.toString().padStart(2, "0") + ":" + seconds.toString().padStart(2, "0");
                
                // æ ¹æ®å‰©ä½™æ—¶é—´è®¾ç½®æ ·å¼
                countdownElement.textContent = timeString;
                countdownElement.className = "countdown";
                
                if (timeLeft <= 60) {
                    // æœ€å1åˆ†é’Ÿï¼Œçº¢è‰²é—ªçƒ
                    countdownElement.className = "countdown danger";
                } else if (timeLeft <= 180) {
                    // æœ€å3åˆ†é’Ÿï¼Œæ©™è‰²è­¦å‘Š
                    countdownElement.className = "countdown warning";
                }
                
                if (timeLeft <= 0) {
                    // æ—¶é—´åˆ°ï¼Œè®¢å•è¿‡æœŸ
                    countdownElement.textContent = "è®¢å•å·²è¿‡æœŸ";
                    countdownElement.className = "countdown danger";
                    
                    // ç§»é™¤äºŒç»´ç å®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    const qrCodeContainer = document.querySelector(".qr-code-container");
                    if (qrCodeContainer) {
                        qrCodeContainer.remove();
                    }
                    
                    // ç¦ç”¨æ”¯ä»˜æŒ‰é’®
                    const payButton = document.getElementById("payButton");
                    if (payButton) {
                        payButton.disabled = true;
                        payButton.textContent = "è®¢å•å·²è¿‡æœŸ";
                        payButton.style.background = "#ccc";
                        payButton.style.cursor = "not-allowed";
                    }
                    
                    // è°ƒç”¨åç«¯å…³é—­æ¥å£ï¼ˆåªè°ƒç”¨ä¸€æ¬¡ï¼‰
                    if (!expired) {
                        expired = true;
                        // å°è¯•é€šçŸ¥åç«¯å…³é—­è®¢å•
                        fetch(`/payment/close?order_number=${encodeURIComponent("<?=$orderNo?>")}`)
                          .then(r => r.json()).then(res => {
                            console.log('å…³é—­ç»“æœ:', res)
                          }).catch(() => {})
                          .finally(() => {
                            alert("è®¢å•å·²è¿‡æœŸï¼Œè¯·é‡æ–°åˆ›å»ºè®¢å•");
                          })
                    }
                    
                    if (timer) {
                        clearInterval(timer);
                    }
                    return;
                }
                
                timeLeft--;
            }
            
            // ç«‹å³æ›´æ–°ä¸€æ¬¡
            updateCountdown();
            
            // æ¯ç§’æ›´æ–°ä¸€æ¬¡
            timer = setInterval(updateCountdown, 1000);
            
            // é¡µé¢å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨
            window.addEventListener("beforeunload", function() {
                if (timer) {
                    clearInterval(timer);
                }
            });
            
            console.log("å€’è®¡æ—¶å·²å¯åŠ¨ï¼Œå‰©ä½™æ—¶é—´ï¼š", Math.floor(timeLeft / 60), "åˆ†", timeLeft % 60, "ç§’");
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºæ”¯ä»˜æŒ‰é’®ï¼Œä¸è‡ªåŠ¨æäº¤
        document.addEventListener("DOMContentLoaded", function() {
            console.log("æ”¯ä»˜é¡µé¢åŠ è½½å®Œæˆ");
            console.log("è®¢å•å·:", "<?=$orderNo?>");
            console.log("æ”¯ä»˜é‡‘é¢:", "Â¥<?=$amount?>");
            console.log("è¯·ç‚¹å‡»\"ç«‹å³æ”¯ä»˜\"æŒ‰é’®å®Œæˆæ”¯ä»˜");
            
            // ç«‹å³å¯åŠ¨å€’è®¡æ—¶
            startCountdown();
            
            // äºŒç»´ç åº“ä¼šåœ¨DOMContentLoadedäº‹ä»¶ä¸­è‡ªåŠ¨åŠ è½½å¹¶ç”ŸæˆäºŒç»´ç 
        });
    </script>
</body>
</html>